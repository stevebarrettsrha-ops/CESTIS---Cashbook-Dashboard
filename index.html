<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CESTIS Cash Book Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Google Identity Services for OAuth -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
:root {
    --bg: #0c0f1a;
    --surface: #141827;
    --surface2: #1a1f35;
    --surface3: #222842;
    --border: #2a3050;
    --text: #e8eaf0;
    --text2: #9ba3bf;
    --text3: #6a7294;
    --accent: #3b82f6;
    --accent2: #60a5fa;
    --green: #22c55e;
    --green-bg: rgba(34,197,94,0.1);
    --red: #ef4444;
    --red-bg: rgba(239,68,68,0.1);
    --amber: #f59e0b;
    --amber-bg: rgba(245,158,11,0.1);
    --purple: #a855f7;
    --teal: #14b8a6;
    --pink: #ec4899;
    --mono: 'JetBrains Mono', monospace;
    --sans: 'DM Sans', sans-serif;
    --radius: 10px;
    --shadow: 0 4px 24px rgba(0,0,0,0.3);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: var(--sans); background: var(--bg); color: var(--text); min-height: 100vh; }
input, select, button, textarea { font-family: var(--sans); }

/* Scrollbar */
::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:var(--surface); }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

/* Layout */
.app { display:grid; grid-template-columns:240px 1fr; min-height:100vh; }

/* Sidebar */
.sidebar {
    background: var(--surface);
    border-right:1px solid var(--border);
    padding:1.5rem 0;
    display:flex; flex-direction:column;
    position:sticky; top:0; height:100vh;
    overflow-y:auto;
}
.logo { padding:0 1.25rem 1.5rem; border-bottom:1px solid var(--border); margin-bottom:1rem; }
.logo h1 { font-size:.85rem; font-weight:700; color:var(--accent2); letter-spacing:1px; text-transform:uppercase; }
.logo p { font-size:.7rem; color:var(--text3); margin-top:.25rem; }
.nav-section { padding:0 .75rem; margin-bottom:.5rem; }
.nav-label { font-size:.6rem; font-weight:600; color:var(--text3); text-transform:uppercase; letter-spacing:1.5px; padding:.5rem .5rem; }
.nav-item {
    display:flex; align-items:center; gap:.625rem;
    padding:.625rem .75rem; border-radius:8px; cursor:pointer;
    color:var(--text2); font-size:.8125rem; font-weight:500;
    transition: all .15s;
}
.nav-item:hover { background:var(--surface2); color:var(--text); }
.nav-item.active { background:rgba(59,130,246,0.12); color:var(--accent2); }
.nav-item .icon { font-size:1rem; width:1.25rem; text-align:center; }
.sidebar-footer { margin-top:auto; padding:1rem 1.25rem; border-top:1px solid var(--border); }
.sidebar-footer p { font-size:.65rem; color:var(--text3); }

/* Main */
.main { padding:1.5rem 2rem; overflow-y:auto; }
.page { display:none; }
.page.active { display:block; }

/* Header */
.page-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1.5rem; flex-wrap:wrap; gap:1rem; }
.page-header h2 { font-size:1.375rem; font-weight:700; }
.page-header .subtitle { font-size:.8125rem; color:var(--text3); margin-top:.125rem; }
.header-actions { display:flex; gap:.5rem; flex-wrap:wrap; }

/* Buttons */
.btn {
    padding:.5rem 1rem; border:none; border-radius:6px; cursor:pointer;
    font-size:.8125rem; font-weight:600; display:inline-flex; align-items:center; gap:.375rem;
    transition:all .15s;
}
.btn-primary { background:var(--accent); color:#fff; }
.btn-primary:hover { background:#2563eb; }
.btn-success { background:var(--green); color:#fff; }
.btn-success:hover { background:#16a34a; }
.btn-danger { background:var(--red); color:#fff; }
.btn-danger:hover { background:#dc2626; }
.btn-ghost { background:var(--surface2); color:var(--text2); border:1px solid var(--border); }
.btn-ghost:hover { background:var(--surface3); color:var(--text); }
.btn-amber { background:var(--amber); color:#000; }
.btn-sm { padding:.375rem .625rem; font-size:.75rem; }

/* Stats Grid */
.stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:1rem; margin-bottom:1.5rem; }
.stat-card {
    background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
    padding:1.25rem; position:relative; overflow:hidden;
}
.stat-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:2px;
}
.stat-card.blue::before { background:var(--accent); }
.stat-card.green::before { background:var(--green); }
.stat-card.red::before { background:var(--red); }
.stat-card.amber::before { background:var(--amber); }
.stat-card.purple::before { background:var(--purple); }
.stat-card .label { font-size:.6875rem; font-weight:600; color:var(--text3); text-transform:uppercase; letter-spacing:.75px; }
.stat-card .value { font-size:1.5rem; font-weight:700; font-family:var(--mono); margin:.375rem 0 .125rem; }
.stat-card .change { font-size:.6875rem; color:var(--text3); }
.stat-card .value.green-text { color:var(--green); }
.stat-card .value.red-text { color:var(--red); }
.stat-card .value.amber-text { color:var(--amber); }

/* Cards */
.card {
    background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
    padding:1.25rem; margin-bottom:1rem;
}
.card-title { font-size:.9375rem; font-weight:700; margin-bottom:1rem; display:flex; align-items:center; gap:.5rem; }
.card-title .badge {
    font-size:.625rem; padding:.125rem .5rem; border-radius:10px; font-weight:600;
    background:rgba(59,130,246,0.15); color:var(--accent2);
}

/* Table */
.table-wrap { overflow-x:auto; }
table { width:100%; border-collapse:collapse; font-size:.8125rem; }
thead th {
    background:var(--surface2); color:var(--text2); font-weight:600; font-size:.6875rem;
    text-transform:uppercase; letter-spacing:.5px; padding:.625rem .75rem;
    text-align:left; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:2;
}
tbody td {
    padding:.5rem .75rem; border-bottom:1px solid var(--border);
    vertical-align:middle;
}
tbody tr:hover { background:var(--surface2); }
tbody tr.cancelled { opacity:.45; text-decoration:line-through; }
tbody tr.deposit-row { background:var(--green-bg); }
tbody tr.bank-charge { color:var(--text3); font-style:italic; }
.amount { font-family:var(--mono); font-weight:500; text-align:right; white-space:nowrap; }
.amount.positive { color:var(--green); }
.amount.negative { color:var(--red); }
.cheque-num { font-family:var(--mono); color:var(--purple); font-weight:500; }
.tag {
    display:inline-block; padding:.125rem .5rem; border-radius:4px;
    font-size:.6875rem; font-weight:600;
}
.tag-salary { background:rgba(59,130,246,0.12); color:var(--accent2); }
.tag-statutory { background:rgba(168,85,247,0.12); color:var(--purple); }
.tag-admin { background:rgba(245,158,11,0.12); color:var(--amber); }
.tag-maintenance { background:rgba(236,72,153,0.12); color:var(--pink); }
.tag-utility { background:rgba(20,184,166,0.12); color:var(--teal); }
.tag-lunch { background:rgba(34,197,94,0.12); color:var(--green); }
.tag-bank { background:rgba(107,114,148,0.12); color:var(--text3); }
.tag-cancelled { background:rgba(239,68,68,0.1); color:var(--red); }
.tag-travel { background:rgba(251,146,60,0.12); color:#fb923c; }
.tag-instructor { background:rgba(99,102,241,0.12); color:#818cf8; }
.tag-subvention { background:rgba(34,197,94,0.15); color:var(--green); }

/* Charts */
.charts-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap:1rem; margin-bottom:1rem; }
.chart-container { position:relative; height:280px; }

/* Budget Table */
.budget-vs-actual-wrap { overflow-x:auto; }
.budget-vs-actual-table { width:100%; border-collapse:collapse; font-size:.8125rem; }
.budget-vs-actual-table thead th {
    background:var(--surface2); color:var(--text2); font-weight:600; font-size:.6875rem;
    text-transform:uppercase; letter-spacing:.5px; padding:.625rem .75rem;
    text-align:left; border-bottom:1px solid var(--border); white-space:nowrap;
}
.budget-vs-actual-table thead th.col-right { text-align:right; }
.budget-vs-actual-table tbody td { padding:.5rem .75rem; border-bottom:1px solid var(--border); vertical-align:middle; }
.budget-vs-actual-table tbody tr:hover { background:var(--surface2); }
.budget-vs-actual-table tbody tr.total-row { font-weight:700; background:var(--surface2); }
.budget-vs-actual-table tbody tr.total-row td { border-bottom:none; }
.budget-vs-actual-table .bar-cell { display:flex; align-items:center; gap:.5rem; min-width:100px; }
.mini-bar { height:6px; border-radius:3px; background:var(--surface3); flex:1; overflow:hidden; }
.mini-bar-fill { height:100%; border-radius:3px; transition:width .3s; }
.mini-bar-fill.under { background:var(--green); }
.mini-bar-fill.over { background:var(--red); }
.mini-bar-fill.warning { background:var(--amber); }

/* Form */
.form-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:1rem; }
.form-group { display:flex; flex-direction:column; gap:.25rem; }
.form-group label { font-size:.75rem; font-weight:600; color:var(--text2); }
.form-group input, .form-group select, .form-group textarea {
    padding:.5rem .75rem; background:var(--surface2); border:1px solid var(--border);
    border-radius:6px; color:var(--text); font-size:.8125rem;
}
.form-group input:focus, .form-group select:focus {
    outline:none; border-color:var(--accent); box-shadow:0 0 0 2px rgba(59,130,246,.15);
}

/* Modal */
.modal-overlay {
    display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:100;
    align-items:center; justify-content:center; padding:1rem;
}
.modal-overlay.show { display:flex; }
.modal {
    background:var(--surface); border:1px solid var(--border); border-radius:12px;
    padding:1.5rem; max-width:640px; width:100%; max-height:85vh; overflow-y:auto;
}
.modal h3 { font-size:1.125rem; margin-bottom:1rem; }
.modal-actions { display:flex; gap:.5rem; justify-content:flex-end; margin-top:1.25rem; }

/* Financial Summary */
.fin-summary { display:grid; grid-template-columns:1fr auto 1fr; gap:1rem; align-items:stretch; margin-bottom:1.5rem; }
.fin-box { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:1.25rem; }
.fin-box h4 { font-size:.6875rem; font-weight:600; color:var(--text3); text-transform:uppercase; letter-spacing:1px; margin-bottom:.75rem; }
.fin-line { display:flex; justify-content:space-between; padding:.375rem 0; font-size:.8125rem; border-bottom:1px dashed var(--border); }
.fin-line:last-child { border-bottom:none; }
.fin-line.total { font-weight:700; font-size:.9375rem; border-top:2px solid var(--border); border-bottom:none; padding-top:.625rem; margin-top:.375rem; }
.fin-connector { display:flex; align-items:center; justify-content:center; color:var(--text3); font-size:1.5rem; }

/* Monthly tabs */
.month-tabs { display:flex; gap:.25rem; margin-bottom:1rem; }
.month-tab {
    padding:.5rem 1rem; border-radius:6px; cursor:pointer; font-size:.8125rem; font-weight:600;
    background:var(--surface2); color:var(--text3); border:1px solid transparent; transition:all .15s;
}
.month-tab:hover { color:var(--text); }
.month-tab.active { background:rgba(59,130,246,0.12); color:var(--accent2); border-color:var(--accent); }

/* Search */
.search-bar {
    display:flex; align-items:center; gap:.5rem; background:var(--surface2); border:1px solid var(--border);
    border-radius:6px; padding:.375rem .75rem; flex:1; max-width:320px;
}
.search-bar input { border:none; background:none; color:var(--text); font-size:.8125rem; flex:1; outline:none; }

/* Monthly Bank Reconciliation */
.recon-fy-nav {
    display:flex; align-items:center; justify-content:center; gap:1rem;
    margin-bottom:1.5rem; padding:.75rem; background:var(--surface); border:1px solid var(--border);
    border-radius:var(--radius);
}
.recon-fy-label { font-size:1.125rem; font-weight:700; color:var(--accent2); font-family:var(--mono); }
.recon-quarter-label {
    font-size:.75rem; font-weight:700; color:var(--text3); text-transform:uppercase; letter-spacing:1.5px;
    margin:1.5rem 0 .75rem; padding-bottom:.5rem; border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:.5rem;
}
.recon-quarter-label .badge { font-size:.625rem; letter-spacing:0; text-transform:none; }
.recon-month-card {
    background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
    margin-bottom:1rem; overflow:hidden;
}
.recon-month-card.matched { border-left:3px solid var(--green); }
.recon-month-card.unmatched { border-left:3px solid var(--red); }
.recon-month-card.pending { border-left:3px solid var(--amber); }
.recon-month-header {
    display:flex; justify-content:space-between; align-items:center;
    padding:1rem 1.25rem; border-bottom:1px solid var(--border); background:var(--surface2);
}
.recon-month-header h3 { font-size:.9375rem; font-weight:700; display:flex; align-items:center; gap:.5rem; }
.recon-month-body { padding:1.25rem; }
.recon-month-stats {
    display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:1rem; margin-bottom:1.25rem;
}
.recon-month-stat .stat-label { font-size:.6875rem; font-weight:600; color:var(--text3); text-transform:uppercase; letter-spacing:.5px; margin-bottom:.25rem; }
.recon-month-stat .stat-value { font-size:1.125rem; font-weight:700; font-family:var(--mono); }
.recon-month-bank {
    display:flex; align-items:center; gap:1rem; padding:1rem; background:var(--surface2);
    border:1px solid var(--border); border-radius:8px; flex-wrap:wrap;
}
.recon-month-bank label { font-size:.75rem; font-weight:600; color:var(--text2); white-space:nowrap; }
.recon-month-bank input[type="number"] {
    width:160px; background:var(--surface3); border:1px solid var(--border); border-radius:6px;
    color:var(--text); font-family:var(--mono); font-size:.875rem; padding:.5rem .75rem; text-align:right;
}
.recon-month-bank input[type="number"]:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 2px rgba(59,130,246,0.2); }
.recon-month-bank .recon-diff { font-family:var(--mono); font-weight:700; font-size:.875rem; margin-left:auto; }
.recon-status { display:inline-block; padding:.25rem .625rem; border-radius:4px; font-size:.6875rem; font-weight:600; }
.recon-status.matched { background:var(--green-bg); color:var(--green); }
.recon-status.unmatched { background:var(--red-bg); color:var(--red); }
.recon-status.pending { background:var(--amber-bg); color:var(--amber); }
.recon-summary-grid {
    display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem;
}
.recon-summary-item {
    background:var(--surface2); border:1px solid var(--border); border-radius:8px;
    padding:1rem; text-align:center;
}
.recon-summary-item .label { font-size:.6875rem; font-weight:600; color:var(--text3); text-transform:uppercase; letter-spacing:.5px; margin-bottom:.375rem; }
.recon-summary-item .value { font-size:1.25rem; font-weight:700; font-family:var(--mono); }

/* Enhanced Recon Card Details */
.recon-month-details {
    display:flex; flex-direction:column; gap:.25rem; margin-bottom:1rem;
    padding:.75rem; background:var(--surface2); border-radius:6px; border:1px solid var(--border);
}
.recon-detail-row {
    display:flex; justify-content:space-between; align-items:center;
    font-size:.8125rem; padding:.25rem 0;
}
.recon-detail-row.subtotal { border-top:1px dashed var(--border); padding-top:.5rem; margin-top:.25rem; font-weight:700; }
.recon-detail-row .detail-label { color:var(--text2); }
.recon-detail-row .detail-value { font-family:var(--mono); font-weight:600; }
.recon-cheques-toggle {
    background:none; border:none; color:var(--accent2); font-size:.75rem;
    cursor:pointer; padding:.375rem 0; font-weight:600; display:block;
}
.recon-cheques-toggle:hover { text-decoration:underline; }
.recon-cheques-list {
    max-height:0; overflow:hidden; transition:max-height .3s ease;
}
.recon-cheques-list.open { max-height:300px; overflow-y:auto; }
.recon-cheques-list table { font-size:.75rem; }
.recon-cheques-list th { background:var(--surface2); color:var(--text3); font-size:.625rem; padding:.375rem .5rem; }
.recon-cheques-list td { padding:.25rem .5rem; border-bottom:1px solid var(--border); }

/* Uncleared cheque checkbox */
.recon-cheques-list td input[type="checkbox"] {
    width:14px; height:14px; cursor:pointer; accent-color:var(--amber);
}
.recon-cheques-list tr.cheque-uncleared { background:rgba(245,158,11,0.08); }
.recon-cheques-list tr.cheque-uncleared td { color:var(--amber); }

/* Bank Reconciliation Statement */
.recon-statement {
    margin-top:1rem; padding:1rem 1.25rem;
    background:var(--surface2); border:1px solid var(--border); border-radius:8px;
    border-left:3px solid var(--accent);
}
.recon-statement-title {
    font-size:.75rem; font-weight:700; color:var(--accent2); text-transform:uppercase;
    letter-spacing:1px; margin-bottom:.75rem; display:flex; align-items:center; gap:.5rem;
}
.recon-statement-line {
    display:flex; justify-content:space-between; align-items:center;
    font-size:.8125rem; padding:.3rem 0;
}
.recon-statement-line .rs-label { color:var(--text2); }
.recon-statement-line .rs-value { font-family:var(--mono); font-weight:600; }
.recon-statement-line.rs-indent { padding-left:1.25rem; font-size:.75rem; }
.recon-statement-line.rs-indent .rs-label { color:var(--text3); font-style:italic; }
.recon-statement-line.rs-indent .rs-value { font-weight:500; color:var(--amber); }
.recon-statement-line.rs-subtotal {
    border-top:1px dashed var(--border); padding-top:.5rem; margin-top:.25rem;
}
.recon-statement-line.rs-total {
    border-top:2px solid var(--border); padding-top:.625rem; margin-top:.5rem;
    font-weight:700; font-size:.875rem;
}
.recon-statement-line.rs-total .rs-label { color:var(--text); }

/* Print */
@media print {
    .sidebar, .header-actions, .btn, .nav-item, .search-bar { display:none !important; }
    .app { grid-template-columns:1fr; }
    .main { padding:.5rem; }
    .stat-card, .card { break-inside:avoid; }
    body { background:#fff; color:#000; }
    .stat-card, .card { background:#fff; border:1px solid #ccc; }
}

/* Budget Lines Styles */
.budget-lines-grid {
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
    gap:1rem;
    margin-bottom:1.5rem;
}
.budget-summary-card {
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:1.25rem;
    position:relative;
    overflow:hidden;
}
.budget-summary-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:2px;
}
.budget-summary-card.card-blue::before { background:var(--accent); }
.budget-summary-card.card-green::before { background:var(--green); }
.budget-summary-card.card-red::before { background:var(--red); }
.budget-summary-card.card-amber::before { background:var(--amber); }
.budget-summary-card.card-purple::before { background:var(--purple); }
.budget-summary-label {
    font-size:.6875rem;
    font-weight:600;
    color:var(--text3);
    text-transform:uppercase;
    letter-spacing:.75px;
}
.budget-summary-value {
    font-size:1.5rem;
    font-weight:700;
    font-family:var(--mono);
    margin:.375rem 0 .125rem;
}
.budget-summary-sub {
    font-size:.6875rem;
    color:var(--text3);
}
.budget-form-section {
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:1.25rem;
}
.budget-form-grid {
    display:grid;
    grid-template-columns:1fr 1fr auto;
    gap:1rem;
    align-items:end;
}
.budget-list {
    overflow-x:auto;
}
.budget-table {
    width:100%;
    border-collapse:collapse;
    font-size:.8125rem;
}
.budget-table thead th {
    background:var(--surface2);
    color:var(--text2);
    font-weight:600;
    font-size:.6875rem;
    text-transform:uppercase;
    letter-spacing:.5px;
    padding:.625rem .75rem;
    text-align:left;
    border-bottom:1px solid var(--border);
    position:sticky;
    top:0;
    z-index:2;
    white-space:nowrap;
}
.budget-table thead th.col-right { text-align:right; }
.budget-table tbody td {
    padding:.5rem .75rem;
    border-bottom:1px solid var(--border);
    vertical-align:middle;
}
.budget-table tbody tr:hover { background:var(--surface2); }
.budget-table tbody tr.total-row {
    font-weight:700;
    background:var(--surface2);
}
.budget-table tbody tr.total-row td { border-bottom:none; }
.budget-item-name {
    font-weight:600;
    color:var(--text);
    white-space:nowrap;
}
.budget-table .amount {
    font-family:var(--mono);
    font-weight:500;
    text-align:right;
    white-space:nowrap;
}
.budget-table .amount.positive { color:var(--green); }
.budget-table .amount.negative { color:var(--red); }
.budget-table .amount.accent { color:var(--accent2); }
.budget-table .amount.muted { color:var(--text3); }
.budget-item-actions {
    display:flex;
    gap:6px;
    justify-content:flex-end;
    white-space:nowrap;
}
.budget-usage-cell {
    display:flex;
    align-items:center;
    gap:.5rem;
    min-width:100px;
}
.budget-usage-cell .mini-bar { flex:1; min-width:50px; }
.budget-usage-cell .pct-label {
    font-size:.7rem;
    color:var(--text3);
    min-width:38px;
    text-align:right;
    white-space:nowrap;
}
.empty-state {
    text-align:center;
    padding:3rem 1.25rem;
    color:var(--text3);
}
.empty-state-icon {
    font-size:2.5rem;
    margin-bottom:.75rem;
}
/* Budget Lines Search */
.budget-search-bar {
    display:flex;
    align-items:center;
    gap:.5rem;
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:6px;
    padding:.375rem .75rem;
    flex:1;
    max-width:320px;
}
.budget-search-bar input {
    border:none;
    background:none;
    color:var(--text);
    font-size:.8125rem;
    flex:1;
    outline:none;
}
/* Quarter Navigation */
.quarter-nav {
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:1rem 1.25rem;
    margin-bottom:1rem;
    position:relative;
    overflow:hidden;
}
.quarter-nav::before {
    content:''; position:absolute; top:0; left:0; right:0; height:2px; background:var(--accent);
}
.quarter-fy-row {
    display:flex;
    align-items:center;
    justify-content:center;
    gap:.75rem;
    margin-bottom:.75rem;
}
.quarter-fy-label {
    font-size:1rem;
    font-weight:700;
    font-family:var(--mono);
    min-width:140px;
    text-align:center;
}
.quarter-tabs-row {
    display:flex;
    align-items:center;
    justify-content:center;
    gap:.25rem;
    flex-wrap:wrap;
}
.quarter-tab {
    padding:.5rem 1rem;
    border-radius:6px;
    cursor:pointer;
    font-size:.75rem;
    font-weight:600;
    background:var(--surface2);
    color:var(--text3);
    border:1px solid transparent;
    transition:all .15s;
    white-space:nowrap;
}
.quarter-tab:hover { color:var(--text); background:var(--surface3); }
.quarter-tab.active {
    background:rgba(59,130,246,0.12);
    color:var(--accent2);
    border-color:var(--accent);
}
.quarter-nav-arrows {
    display:flex;
    align-items:center;
    gap:.5rem;
    margin-left:.75rem;
}
.quarter-bf-row {
    display:flex;
    align-items:center;
    justify-content:center;
    gap:.75rem;
    margin-top:.75rem;
    padding-top:.75rem;
    border-top:1px solid var(--border);
}
.quarter-bf-row label {
    font-size:.75rem;
    font-weight:600;
    color:var(--text2);
}
.quarter-bf-row input {
    padding:.375rem .625rem;
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:6px;
    color:var(--text);
    font-size:.8125rem;
    font-family:var(--mono);
    width:160px;
    text-align:right;
}
.quarter-bf-row input:focus {
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 2px rgba(59,130,246,.15);
}
.quarter-bf-row .bf-display {
    font-family:var(--mono);
    font-weight:600;
    font-size:.875rem;
    color:var(--green);
}
.quarter-subvention-row {
    display:flex;
    align-items:center;
    justify-content:center;
    gap:.75rem;
    margin-top:.5rem;
    padding-top:.5rem;
    border-top:1px dashed var(--border);
    flex-wrap:wrap;
}
.quarter-subvention-row label {
    font-size:.75rem;
    font-weight:600;
    color:var(--green);
}
.quarter-subvention-row input {
    padding:.375rem .625rem;
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:6px;
    color:var(--text);
    font-size:.8125rem;
    font-family:var(--mono);
    text-align:right;
}
.quarter-subvention-row input[type="date"] {
    width:150px;
    text-align:center;
}
.quarter-subvention-row input[type="number"] {
    width:160px;
}
.quarter-subvention-row input:focus {
    outline:none;
    border-color:var(--green);
    box-shadow:0 0 0 2px rgba(34,197,94,.15);
}
.subvention-status {
    font-size:.7rem;
    font-family:var(--mono);
    padding:.25rem .5rem;
    border-radius:4px;
    background:var(--green-bg);
    color:var(--green);
    font-weight:600;
}
.btn-nav {
    background:var(--surface2);
    color:var(--text2);
    border:1px solid var(--border);
    padding:.375rem .625rem;
    border-radius:6px;
    cursor:pointer;
    font-size:.75rem;
    font-weight:700;
    transition:all .15s;
}
.btn-nav:hover { background:var(--surface3); color:var(--text); }
.btn-nav:disabled { opacity:.3; cursor:not-allowed; }

/* Void Cheque Section */
.void-cheque-card {
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:1.25rem;
    margin-bottom:1rem;
    position:relative;
    overflow:hidden;
}
.void-cheque-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:2px; background:var(--amber);
}
.void-cheque-grid {
    display:grid;
    grid-template-columns:1fr auto;
    gap:1rem;
    align-items:end;
}
.void-cheque-select-wrap {
    position:relative;
}
.void-cheque-search {
    padding:.5rem .75rem;
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:6px 6px 0 0;
    color:var(--text);
    font-size:.8125rem;
    width:100%;
    outline:none;
    border-bottom:none;
}
.void-cheque-search:focus {
    border-color:var(--accent);
    box-shadow:0 0 0 2px rgba(59,130,246,.15);
}
.void-cheque-select {
    width:100%;
    padding:.5rem .75rem;
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:0 0 6px 6px;
    color:var(--text);
    font-size:.8125rem;
    font-family:var(--mono);
    outline:none;
}
.void-cheque-select:focus {
    border-color:var(--accent);
    box-shadow:0 0 0 2px rgba(59,130,246,.15);
}
.void-cheque-select option {
    background:var(--surface2);
    color:var(--text);
    padding:.25rem;
}
.void-cheque-preview {
    margin-top:.75rem;
    padding:.75rem 1rem;
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:6px;
    font-size:.8125rem;
    display:none;
}
.void-cheque-preview.show { display:block; }
.void-cheque-preview .preview-row {
    display:flex;
    justify-content:space-between;
    padding:.25rem 0;
}
.void-cheque-preview .preview-label {
    color:var(--text3);
    font-size:.75rem;
}
.void-cheque-preview .preview-value {
    font-weight:600;
}
.void-count-badge {
    font-size:.625rem;
    padding:.125rem .5rem;
    border-radius:10px;
    font-weight:600;
    background:rgba(239,68,68,0.15);
    color:var(--red);
    margin-left:.5rem;
}
.unvoid-divider {
    border-top:1px solid var(--border);
    margin:1rem 0;
}
.btn-unvoid {
    background:var(--green);
    color:#fff;
    padding:.5rem 1rem;
    border:none;
    border-radius:6px;
    font-weight:600;
    cursor:pointer;
    font-size:.8125rem;
}
.btn-unvoid:hover { background:#16a34a; }
.btn-unvoid:disabled { opacity:.5; cursor:not-allowed; }

/* Budget Line Edit Modal */
.budget-edit-modal .form-grid {
    gap:1rem;
}
.budget-edit-modal .modal h3 {
    display:flex;
    align-items:center;
    gap:.5rem;
}

/* ============================================================
   LOGIN SCREEN
   ============================================================ */
.login-overlay {
    position:fixed; inset:0; z-index:9999;
    background:var(--bg);
    display:flex; align-items:center; justify-content:center;
    opacity:1; transition:opacity .5s ease, visibility .5s ease;
}
.login-overlay.hidden {
    opacity:0; visibility:hidden; pointer-events:none;
}
.login-container {
    width:100%; max-width:420px; padding:2rem;
    position:relative;
}
/* Claude Code Crab */
.crab-wrapper {
    position:absolute; left:50%; bottom:100%;
    transform:translateX(-50%);
    margin-bottom:-26px; /* half the crab peeking above the card */
    pointer-events:none; z-index:10001;
}
.crab-svg { width:64px; height:52px; image-rendering:pixelated; }

/* Default BLUE palette (resting) */
.crab-svg .body       { fill:#60a5fa; transition:fill .25s; }
.crab-svg .body-shade { fill:#3b82f6; transition:fill .25s; }
.crab-svg .eye-white  { fill:#ffffff; }
.crab-svg .eye-pupil  { fill:#1a1a2e; transition:cx .15s ease, cy .15s ease; }
.crab-svg .eye-shine  { fill:#ffffff; transition:cx .15s ease, cy .15s ease; }
.crab-svg .claw       { fill:#60a5fa; transition:fill .25s; }
.crab-svg .claw-shade { fill:#3b82f6; transition:fill .25s; }
.crab-svg .leg        { fill:#3b82f6; transition:fill .25s; }
.crab-svg .mouth-happy { stroke:#1a1a2e; }
.crab-svg .eye-closed-l, .crab-svg .eye-closed-r { stroke:#1a1a2e; opacity:0; transition:opacity .15s; }

/* Fleeing = RED palette */
.crab-wrapper.fleeing .crab-svg .body       { fill:#f87171; }
.crab-wrapper.fleeing .crab-svg .body-shade { fill:#ef4444; }
.crab-wrapper.fleeing .crab-svg .claw       { fill:#f87171; }
.crab-wrapper.fleeing .crab-svg .claw-shade { fill:#ef4444; }
.crab-wrapper.fleeing .crab-svg .leg        { fill:#ef4444; }

/* Fleeing face: closed eyes */
.crab-wrapper.fleeing .crab-svg .eye-white  { opacity:0; }
.crab-wrapper.fleeing .crab-svg .eye-pupil  { opacity:0; }
.crab-wrapper.fleeing .crab-svg .eye-shine  { opacity:0; }
.crab-wrapper.fleeing .crab-svg .eye-closed-l,
.crab-wrapper.fleeing .crab-svg .eye-closed-r { opacity:1; }

.crab-wrapper.flipped .crab-svg { transform:scaleX(-1); }

/* Blink animation while resting */
@keyframes blink {
    0%,42%,46%,100% { transform:scaleY(1); }
    44% { transform:scaleY(0.08); }
}
.crab-svg .eye-group { transform-origin:center; animation:blink 3.5s ease-in-out infinite; }

/* Leg scuttle animation */
@keyframes scuttleLeft {
    0%,100% { transform:rotate(0deg); }
    25%     { transform:rotate(-18deg); }
    75%     { transform:rotate(18deg); }
}
@keyframes scuttleRight {
    0%,100% { transform:rotate(0deg); }
    25%     { transform:rotate(18deg); }
    75%     { transform:rotate(-18deg); }
}
.crab-wrapper.fleeing .leg-l1 { animation:scuttleLeft  .18s ease-in-out infinite; transform-origin:top center; }
.crab-wrapper.fleeing .leg-l2 { animation:scuttleRight .18s ease-in-out infinite; transform-origin:top center; }
.crab-wrapper.fleeing .leg-r1 { animation:scuttleRight .18s ease-in-out infinite; transform-origin:top center; }
.crab-wrapper.fleeing .leg-r2 { animation:scuttleLeft  .18s ease-in-out infinite; transform-origin:top center; }

/* Claw snip animation */
@keyframes snipLeft {
    0%,100% { transform:rotate(0deg) translateY(0); }
    50%     { transform:rotate(-20deg) translateY(-3px); }
}
@keyframes snipRight {
    0%,100% { transform:rotate(0deg) translateY(0); }
    50%     { transform:rotate(20deg) translateY(-3px); }
}
.crab-wrapper.fleeing .claw-group-l { animation:snipLeft  .22s ease-in-out infinite; transform-origin:right center; }
.crab-wrapper.fleeing .claw-group-r { animation:snipRight .22s ease-in-out infinite; transform-origin:left center; }
.login-card-wrap {
    position:relative;
}
.login-card {
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:16px;
    padding:2.5rem 2rem 2rem;
    position:relative;
    overflow:hidden;
    box-shadow:0 8px 48px rgba(0,0,0,0.45), 0 0 0 1px rgba(59,130,246,0.08);
}
.login-card::before {
    content:'';
    position:absolute; top:0; left:0; right:0; height:3px;
    background:linear-gradient(90deg, var(--accent), var(--purple), var(--teal));
}
.login-glow {
    position:absolute; top:-80px; left:50%; transform:translateX(-50%);
    width:300px; height:160px;
    background:radial-gradient(ellipse, rgba(59,130,246,0.12) 0%, transparent 70%);
    pointer-events:none;
}
.login-brand {
    text-align:center; margin-bottom:2rem;
}
.login-brand-icon {
    display:inline-flex; align-items:center; justify-content:center;
    width:56px; height:56px; border-radius:14px;
    background:linear-gradient(135deg, rgba(59,130,246,0.15), rgba(168,85,247,0.15));
    border:1px solid rgba(59,130,246,0.2);
    font-size:1.5rem; margin-bottom:1rem;
}
.login-brand h1 {
    font-size:1.25rem; font-weight:700; color:var(--accent2);
    letter-spacing:1.5px; text-transform:uppercase;
}
.login-brand p {
    font-size:.75rem; color:var(--text3); margin-top:.25rem;
}
.login-form { display:flex; flex-direction:column; gap:1.25rem; }
.login-field { position:relative; }
.login-field label {
    display:block; font-size:.6875rem; font-weight:600;
    color:var(--text3); text-transform:uppercase; letter-spacing:.75px;
    margin-bottom:.5rem;
}
.login-field .input-wrapper {
    position:relative; display:flex; align-items:center;
}
.login-field .input-icon {
    position:absolute; left:.875rem; font-size:.9rem;
    color:var(--text3); pointer-events:none; transition:color .2s;
}
.login-field input {
    width:100%; padding:.75rem .875rem .75rem 2.5rem;
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:10px;
    color:var(--text); font-size:.875rem;
    transition:all .2s;
}
.login-field input::placeholder { color:var(--text3); }
.login-field input:focus {
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 3px rgba(59,130,246,0.12);
    background:var(--surface3);
}
.login-field input:focus ~ .input-icon,
.login-field input:focus + .input-icon { color:var(--accent2); }
.login-field .toggle-password {
    position:absolute; right:.75rem;
    background:none; border:none; color:var(--text3);
    cursor:pointer; font-size:.85rem; padding:.25rem;
    transition:color .2s;
}
.login-field .toggle-password:hover { color:var(--text); }
.login-btn {
    width:100%; padding:.8rem;
    background:linear-gradient(135deg, var(--accent), #6366f1);
    border:none; border-radius:10px;
    color:#fff; font-size:.875rem; font-weight:700;
    cursor:pointer; transition:all .2s;
    letter-spacing:.5px; position:relative; overflow:hidden;
}
.login-btn:hover {
    box-shadow:0 4px 20px rgba(59,130,246,0.4);
    transform:translateY(-1px);
}
.login-btn:active { transform:translateY(0); }
.login-btn:disabled {
    opacity:.6; cursor:not-allowed; transform:none;
    box-shadow:none;
}
.login-btn .spinner {
    display:inline-block; width:16px; height:16px;
    border:2px solid rgba(255,255,255,0.3);
    border-top-color:#fff; border-radius:50%;
    animation:spin .6s linear infinite;
    vertical-align:middle; margin-right:.5rem;
}
@keyframes spin { to { transform:rotate(360deg); } }
.login-error {
    background:var(--red-bg);
    border:1px solid rgba(239,68,68,0.25);
    border-radius:8px;
    padding:.625rem .875rem;
    font-size:.8rem; color:var(--red);
    display:none; align-items:center; gap:.5rem;
    animation:shakeX .4s;
}
.login-error.visible { display:flex; }
@keyframes shakeX {
    0%,100% { transform:translateX(0); }
    20%,60% { transform:translateX(-6px); }
    40%,80% { transform:translateX(6px); }
}
.login-footer {
    text-align:center; margin-top:1.5rem;
    font-size:.65rem; color:var(--text3);
    line-height:1.6;
}
.login-footer span { color:var(--accent); }
.login-session-info {
    display:flex; align-items:center; justify-content:center;
    gap:.375rem; margin-top:.75rem;
    font-size:.65rem; color:var(--text3);
}
.login-session-info .dot {
    width:5px; height:5px; border-radius:50%;
    background:var(--green); animation:pulse-dot 2s infinite;
}
@keyframes pulse-dot {
    0%,100% { opacity:1; } 50% { opacity:.4; }
}

/* Logout button in sidebar */
.sidebar-logout {
    padding:0 .75rem; margin-top:.5rem;
}
.sidebar-logout .nav-item {
    color:var(--red); opacity:.8;
}
.sidebar-logout .nav-item:hover {
    background:var(--red-bg); color:var(--red); opacity:1;
}

/* App hidden state */
.app.app-hidden {
    display:none;
}

/* ============================================ */
/* CLOUD SYNC & MERGE STYLES                    */
/* ============================================ */
.cloud-section {
    padding: 0.5rem 0.75rem;
    margin-top: 0.25rem;
}
.cloud-section .nav-label {
    font-size: .65rem;
    text-transform: uppercase;
    letter-spacing: .05em;
    color: var(--text3);
    padding: 0.25rem 0;
}
.cloud-dropdown-container {
    position: relative;
}
.cloud-dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.2s ease;
    border: none;
    width: 100%;
    text-align: left;
}
.cloud-dropdown-item:hover {
    transform: translateX(2px);
    box-shadow: 0 2px 8px rgba(156, 39, 176, 0.3);
}
.cloud-status-bar {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    background: var(--surface2);
    color: var(--text2);
    margin-bottom: 0.5rem;
}
.cloud-status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #9E9E9E;
    flex-shrink: 0;
}
.cloud-status-dot.connected {
    background: #4CAF50;
    box-shadow: 0 0 4px rgba(76, 175, 80, 0.5);
}
.cloud-status-dot.syncing {
    background: #FF9800;
    animation: pulse-dot 1s ease-in-out infinite;
}
@keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}
.cloud-connect-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 0.8rem;
    background: var(--surface2);
    color: var(--text);
    border: 1px dashed var(--border);
    width: 100%;
    text-align: left;
    transition: all 0.2s ease;
}
.cloud-connect-btn:hover {
    background: rgba(33, 150, 243, 0.1);
    border-color: #2196F3;
    color: #2196F3;
}
.cloud-sync-info {
    font-size: 0.7rem;
    color: var(--text3);
    padding: 0.25rem 0.75rem;
    line-height: 1.4;
}
@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* Cloud Dropdown Menu */
.cloud-dropdown {
    position: relative;
    display: inline-block;
    width: 100%;
}
.cloud-dropdown-content {
    display: none;
    position: absolute;
    left: 0;
    bottom: 100%;
    background: var(--surface2, #1e2235);
    min-width: 220px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.35);
    border-radius: 8px;
    z-index: 1000;
    overflow: hidden;
    margin-bottom: 4px;
    border: 1px solid var(--border, #2a2f45);
}
.cloud-dropdown-content.show {
    display: block;
}
.cloud-dropdown-divider {
    height: 1px;
    background: var(--border, #2a2f45);
    margin: 4px 0;
}
.cloud-dropdown-item.danger {
    color: #ef4444;
}
.cloud-dropdown-item.danger:hover {
    background-color: rgba(239, 68, 68, 0.1);
    box-shadow: none;
    transform: none;
}
.last-sync-info {
    padding: 6px 16px;
    font-size: 0.7rem;
    color: var(--text3, #94a3b8);
}
.cloud-sync-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 0.8rem;
    background: var(--surface2, #1e2235);
    color: var(--text, #e2e8f0);
    border: 1px solid var(--border, #2a2f45);
    width: 100%;
    text-align: left;
    transition: all 0.2s ease;
}
.cloud-sync-btn:hover {
    background: rgba(33, 150, 243, 0.1);
    border-color: #2196F3;
}
.spinning {
    display: inline-block;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
.google-auth-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}
.google-auth-modal .modal-content {
    max-width: 560px;
    width: 90%;
    background: var(--surface, #141827);
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
    overflow: hidden;
}
.google-auth-modal .modal-header {
    background: linear-gradient(135deg, #2196F3, #00BCD4);
    padding: 1.25rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.google-auth-modal .modal-header h2 {
    color: white;
    margin: 0;
    font-size: 1.2rem;
}
.google-auth-modal .close-btn {
    color: white;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    line-height: 1;
}

/* Responsive */
@media (max-width:900px) {
    .app { grid-template-columns:1fr; }
    .sidebar { display:none; }
    .charts-grid { grid-template-columns:1fr; }
    .fin-summary { grid-template-columns:1fr; }
    .fin-connector { display:none; }
    .budget-form-grid {
        grid-template-columns:1fr;
    }
    .budget-lines-grid {
        grid-template-columns:repeat(2, 1fr);
    }
    .login-container { padding:1rem; }
    .login-card { padding:2rem 1.5rem 1.5rem; }
}
</style>
</head>
<body>

<!-- ============================================================ -->
<!-- LOGIN SCREEN                                                  -->
<!-- ============================================================ -->
<div id="loginOverlay" class="login-overlay">
    <div class="login-container">
        <div class="login-card-wrap">
        <!-- Claude Code Crab mascot -->
        <div class="crab-wrapper" id="crabWrapper">
            <svg class="crab-svg" viewBox="0 0 64 52" xmlns="http://www.w3.org/2000/svg">
                <!-- Left claw (grouped for animation) -->
                <g class="claw-group-l">
                    <rect class="claw" x="2" y="16" width="8" height="6" rx="1"/>
                    <rect class="claw" x="4" y="12" width="6" height="6" rx="1"/>
                    <rect class="claw-shade" x="2" y="20" width="4" height="3" rx="1"/>
                </g>
                <!-- Right claw (grouped for animation) -->
                <g class="claw-group-r">
                    <rect class="claw" x="54" y="16" width="8" height="6" rx="1"/>
                    <rect class="claw" x="54" y="12" width="6" height="6" rx="1"/>
                    <rect class="claw-shade" x="58" y="20" width="4" height="3" rx="1"/>
                </g>
                <!-- Body -->
                <ellipse class="body" cx="32" cy="28" rx="18" ry="14"/>
                <ellipse class="body-shade" cx="32" cy="34" rx="14" ry="7"/>
                <!-- Eyes (grouped for blink) -->
                <g class="eye-group">
                    <ellipse class="eye-white" cx="25" cy="23" rx="5" ry="6"/>
                    <ellipse class="eye-white" cx="39" cy="23" rx="5" ry="6"/>
                    <circle class="eye-pupil" id="pupilL" cx="26" cy="24" r="2.5"/>
                    <circle class="eye-pupil" id="pupilR" cx="40" cy="24" r="2.5"/>
                    <circle class="eye-shine" id="shineL" cx="24.5" cy="22" r="1"/>
                    <circle class="eye-shine" id="shineR" cx="38.5" cy="22" r="1"/>
                </g>
                <!-- Closed eyes  >  <  (shown when fleeing) -->
                <g class="eye-closed-l">
                    <line x1="22" y1="20" x2="27" y2="23" stroke-width="2" stroke-linecap="round"/>
                    <line x1="27" y1="23" x2="22" y2="26" stroke-width="2" stroke-linecap="round"/>
                </g>
                <g class="eye-closed-r">
                    <line x1="42" y1="20" x2="37" y2="23" stroke-width="2" stroke-linecap="round"/>
                    <line x1="37" y1="23" x2="42" y2="26" stroke-width="2" stroke-linecap="round"/>
                </g>
                <!-- Legs (individual for alternating scuttle) -->
                <rect class="leg leg-l1" x="16" y="40" width="3" height="8" rx="1"/>
                <rect class="leg leg-l2" x="22" y="41" width="3" height="9" rx="1"/>
                <rect class="leg leg-r1" x="39" y="41" width="3" height="9" rx="1"/>
                <rect class="leg leg-r2" x="45" y="40" width="3" height="8" rx="1"/>
                <!-- Mouth (always happy) -->
                <path class="mouth-happy" d="M28 32 Q32 35 36 32" stroke-width="1.2" fill="none" stroke-linecap="round"/>
            </svg>
        </div>
        <div class="login-card">
            <div class="login-glow"></div>
            <div class="login-brand">
                <div class="login-brand-icon">&#x1f4bc;</div>
                <h1>CESTIS</h1>
                <p>Cash Book Management System</p>
            </div>
            <form id="loginForm" class="login-form" autocomplete="off" onsubmit="handleLogin(event)">
                <div id="loginError" class="login-error">
                    <span>&#x26A0;</span>
                    <span id="loginErrorMsg">Invalid username or password</span>
                </div>
                <div class="login-field">
                    <label for="loginUser">Username</label>
                    <div class="input-wrapper">
                        <input id="loginUser" type="text" placeholder="Enter your username" required autofocus>
                        <span class="input-icon">&#x1f464;</span>
                    </div>
                </div>
                <div class="login-field">
                    <label for="loginPass">Password</label>
                    <div class="input-wrapper">
                        <input id="loginPass" type="password" placeholder="Enter your password" required>
                        <span class="input-icon">&#x1f512;</span>
                        <button type="button" class="toggle-password" onclick="togglePasswordVisibility()" title="Toggle password visibility">&#x1f441;</button>
                    </div>
                </div>
                <button type="submit" id="loginBtn" class="login-btn">Sign In</button>
            </form>
            <div class="login-footer">
                <p>CESTIS - <span>Financial Management System</span></p>
                <div class="login-session-info">
                    <span class="dot"></span> Secure local session
                </div>
            </div>
        </div>
        </div><!-- /.login-card-wrap -->
    </div>
</div>

<!-- ============================================================ -->
<!-- APP (hidden until authenticated)                              -->
<!-- ============================================================ -->
<div class="app app-hidden" id="appContainer">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <h1>üíº CESTIS</h1>
            <p>Cash Book Manager</p>
        </div>
        <div class="nav-section">
            <div class="nav-label">Overview</div>
            <div class="nav-item active" onclick="showPage('dashboard')"><span class="icon">üìä</span> Dashboard</div>
            <div class="nav-item" onclick="showPage('budgetlines')"><span class="icon">üí∞</span> Budget Lines</div>
            <div class="nav-item" onclick="showPage('transactions')"><span class="icon">üìã</span> Transactions</div>
        </div>
        <div class="nav-section">
            <div class="nav-label">Analysis</div>
            <div class="nav-item" onclick="showPage('budget')"><span class="icon">üìà</span> Budget vs Actual</div>
            <div class="nav-item" onclick="showPage('categories')"><span class="icon">üè∑Ô∏è</span> Categories</div>
            <div class="nav-item" onclick="showPage('monthly')"><span class="icon">üìÖ</span> Monthly View</div>
        </div>
        <div class="nav-section">
            <div class="nav-label">Reporting</div>
            <div class="nav-item" data-page="financial" onclick="showPage('financial')"><span class="icon">üìÑ</span> Financial Data Form</div>
            <div class="nav-item" data-page="reconciliation" onclick="showPage('reconciliation')"><span class="icon">üè¶</span> Reconciliation</div>
            <div class="nav-item" data-page="monthly-recon" onclick="showPageDirect('monthly-recon')"><span class="icon">üìÖ</span> Monthly Recon</div>
        </div>
        <div class="nav-section">
            <div class="nav-label">External Links</div>
            <div class="nav-item" onclick="openExternalLink('staffPayslip')"><span class="icon">üí≥</span> Staff Payslip</div>
            <div class="nav-item" onclick="openExternalLink('virementRequest')"><span class="icon">üì§</span> Virement Request</div>
        </div>
        <!-- Cloud Sync Section -->
        <div class="cloud-section">
            <div class="nav-label">Cloud Sync</div>
            <div class="cloud-status-bar">
                <span class="cloud-status-dot" id="cloudStatusDot"></span>
                <span id="cloudStatusText">Not connected</span>
            </div>
            <div id="cloudNotConnected">
                <button class="cloud-connect-btn" onclick="connectToGoogleDrive()">
                    <span>‚òÅÔ∏è</span>
                    <span>Connect to Google Drive</span>
                </button>
            </div>
            <div id="cloudConnected" style="display: none;">
                <div class="cloud-dropdown">
                    <button class="cloud-sync-btn" onclick="toggleCloudMenu()">
                        <span id="cloudMenuIcon">‚òÅÔ∏è</span>
                        <span>Cloud</span>
                        <span style="font-size: 0.6rem;">&#9660;</span>
                    </button>
                    <div class="cloud-dropdown-content" id="cloudDropdownMenu">
                        <div class="cloud-dropdown-item" onclick="saveToCloud()" style="background: linear-gradient(135deg, #2196F3 0%, #00BCD4 100%); color: white;">
                            <span>üíæ</span>
                            <span>Save to Cloud</span>
                        </div>
                        <div class="cloud-dropdown-item" onclick="syncFromCloud()" style="background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); color: white;">
                            <span>üîÑ</span>
                            <span>Sync from Cloud</span>
                        </div>
                        <div class="cloud-dropdown-item" onclick="mergeFromCloud()" style="background: linear-gradient(135deg, #9C27B0 0%, #E91E63 100%); color: white;">
                            <span>üîÄ</span>
                            <span>Merge from Cloud</span>
                        </div>
                        <div class="cloud-dropdown-item" onclick="browseBackupFiles()" style="background: var(--surface2); color: var(--text);">
                            <span>üìÅ</span>
                            <span>Browse All Backups</span>
                        </div>
                        <div class="cloud-dropdown-divider"></div>
                        <div class="last-sync-info" id="lastSyncInfo">Last sync: Never</div>
                        <div class="last-sync-info" id="lastSavedByInfo">Last saved by: --</div>
                        <div class="cloud-dropdown-divider"></div>
                        <div class="cloud-dropdown-item danger" onclick="disconnectFromGoogleDrive()">
                            <span>üîå</span>
                            <span>Disconnect</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="cloud-sync-info" id="cloudSyncInfo"></div>
        </div>
        <div class="sidebar-logout">
            <div class="nav-item" onclick="handleLogout()"><span class="icon">&#x1F6AA;</span> Sign Out</div>
        </div>
        <div class="sidebar-footer">
            <p>CESTIS-Financial Management</p>
            <p id="sidebarQuarterLabel">Oct‚ÄìDec 2025 Quarter</p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
        <!-- ====== DASHBOARD ====== -->
        <div id="page-dashboard" class="page active">
            <div class="page-header">
                <div>
                    <h2>Cash Book Dashboard</h2>
                    <div class="subtitle" id="dashSubtitle">Hazard STC ¬∑ Subvention Period: Oct‚ÄìDec 2025</div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-ghost" onclick="exportCSV()">‚¨á Export CSV</button>
                    <button class="btn btn-primary" onclick="window.print()">üñ® Print</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="label">Total Budget</div>
                    <div class="value" id="dash-budget">$0</div>
                    <div class="change">Approved subvention + B/F</div>
                </div>
                <div class="stat-card green">
                    <div class="label">Total Deposits</div>
                    <div class="value green-text" id="dash-deposits">$0</div>
                    <div class="change">Subvention received</div>
                </div>
                <div class="stat-card red">
                    <div class="label">Total Expenditure</div>
                    <div class="value red-text" id="dash-spent">$0</div>
                    <div class="change" id="dash-txn-count">0 transactions</div>
                </div>
                <div class="stat-card amber">
                    <div class="label">Closing Balance</div>
                    <div class="value amber-text" id="dash-balance">$0</div>
                    <div class="change">Cash book balance</div>
                </div>
                <div class="stat-card purple">
                    <div class="label">Budget Utilization</div>
                    <div class="value" id="dash-util">0%</div>
                    <div class="change">Spent of available</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="card">
                    <div class="card-title">üìä Expenditure by Category</div>
                    <div class="chart-container"><canvas id="chartCategory"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-title">üìÖ Monthly Expenditure Trend</div>
                    <div class="chart-container"><canvas id="chartMonthly"></canvas></div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="card">
                    <div class="card-title">üí∞ Running Balance Over Time</div>
                    <div class="chart-container"><canvas id="chartBalance"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-title">üéØ Budget vs Actual (All Line Items)</div>
                    <div class="chart-container"><canvas id="chartBudgetVsActual"></canvas></div>
                </div>
            </div>
        </div>

        <!-- ====== TRANSACTIONS ====== -->
        <div id="page-transactions" class="page">
            <div class="page-header">
                <div>
                    <h2>All Transactions</h2>
                    <div class="subtitle">Complete cash book ledger</div>
                </div>
                <div class="header-actions">
                    <div class="search-bar">
                        <span>üîç</span>
                        <input type="text" id="searchInput" placeholder="Search transactions..." oninput="filterTransactions()">
                    </div>
                    <button class="btn btn-success" onclick="openAddModal()">+ Add Entry</button>
                    <button class="btn btn-ghost" onclick="exportCSV()">‚¨á CSV</button>
                </div>
            </div>

            <div class="quarter-nav">
                <div class="quarter-fy-row">
                    <button class="btn-nav" onclick="changeFY(-1)">‚óÄ</button>
                    <span class="quarter-fy-label" id="fyLabel">FY 2025/2026</span>
                    <button class="btn-nav" onclick="changeFY(1)">‚ñ∂</button>
                </div>
                <div class="quarter-tabs-row">
                    <div class="quarter-tab" onclick="switchQuarter(1)">Q1 ¬∑ Apr‚ÄìJun</div>
                    <div class="quarter-tab" onclick="switchQuarter(2)">Q2 ¬∑ Jul‚ÄìSep</div>
                    <div class="quarter-tab active" onclick="switchQuarter(3)">Q3 ¬∑ Oct‚ÄìDec</div>
                    <div class="quarter-tab" onclick="switchQuarter(4)">Q4 ¬∑ Jan‚ÄìMar</div>
                    <div class="quarter-nav-arrows">
                        <button class="btn-nav" onclick="changeQuarter(-1)">‚óÄ Prev Qtr</button>
                        <button class="btn-nav" onclick="changeQuarter(1)">Next Qtr ‚ñ∂</button>
                    </div>
                </div>
                <div class="quarter-bf-row">
                    <label>Balance B/F:</label>
                    <input type="number" id="quarterBF" step="0.01" placeholder="0.00" onchange="updateQuarterBF()">
                    <button class="btn btn-ghost btn-sm" onclick="carryForwardBalance()">Carry from Prev Qtr</button>
                </div>
                <div class="quarter-subvention-row">
                    <label>Subvention:</label>
                    <input type="date" id="subventionDate" onchange="updateSubvention()">
                    <input type="number" id="subventionAmount" step="0.01" placeholder="Amount (0.00)" onchange="updateSubvention()">
                    <span class="subvention-status" id="subventionStatus">No subvention</span>
                </div>
            </div>

            <div class="void-cheque-card">
                <div class="card-title">üö´ Void Cheque <span class="void-count-badge" id="voidCountBadge">0 voided</span></div>
                <div class="void-cheque-grid">
                    <div class="form-group">
                        <label>Select transaction to void</label>
                        <div class="void-cheque-select-wrap">
                            <input type="text" class="void-cheque-search" id="voidChequeSearch" placeholder="Search by cheque #, payee, or details..." oninput="filterVoidDropdown()">
                            <select id="voidChequeSelect" class="void-cheque-select" size="6" onchange="previewVoidCheque()"></select>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-amber" onclick="voidSelectedCheque()" id="voidBtn" disabled>üö´ Void Cheque</button>
                    </div>
                </div>
                <div class="void-cheque-preview" id="voidPreview">
                    <div class="preview-row"><span class="preview-label">Date</span><span class="preview-value" id="voidPreviewDate">-</span></div>
                    <div class="preview-row"><span class="preview-label">Cheque #</span><span class="preview-value" id="voidPreviewCheque">-</span></div>
                    <div class="preview-row"><span class="preview-label">Payee / Details</span><span class="preview-value" id="voidPreviewDetails">-</span></div>
                    <div class="preview-row"><span class="preview-label">Amount</span><span class="preview-value" id="voidPreviewAmount">-</span></div>
                    <div class="preview-row"><span class="preview-label">Category</span><span class="preview-value" id="voidPreviewCategory">-</span></div>
                </div>

                <div class="unvoid-divider"></div>

                <div class="card-title">‚Ü© Unvoid Cheque</div>
                <div class="void-cheque-grid">
                    <div class="form-group">
                        <label>Select voided transaction to restore</label>
                        <div class="void-cheque-select-wrap">
                            <input type="text" class="void-cheque-search" id="unvoidChequeSearch" placeholder="Search voided cheques..." oninput="filterUnvoidDropdown()">
                            <select id="unvoidChequeSelect" class="void-cheque-select" size="6" onchange="previewUnvoidCheque()"></select>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-unvoid" onclick="unvoidSelectedCheque()" id="unvoidBtn" disabled>‚Ü© Unvoid Cheque</button>
                    </div>
                </div>
                <div class="void-cheque-preview" id="unvoidPreview">
                    <div class="preview-row"><span class="preview-label">Date</span><span class="preview-value" id="unvoidPreviewDate">-</span></div>
                    <div class="preview-row"><span class="preview-label">Cheque #</span><span class="preview-value" id="unvoidPreviewCheque">-</span></div>
                    <div class="preview-row"><span class="preview-label">Original Details</span><span class="preview-value" id="unvoidPreviewDetails">-</span></div>
                    <div class="preview-row"><span class="preview-label">Original Amount</span><span class="preview-value" id="unvoidPreviewAmount">-</span></div>
                    <div class="preview-row"><span class="preview-label">Original Category</span><span class="preview-value" id="unvoidPreviewCategory">-</span></div>
                </div>
            </div>

            <div class="month-tabs" id="monthTabsContainer"></div>

            <div class="card" style="padding:0;">
                <div class="table-wrap" style="max-height:65vh; overflow-y:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:80px;">Date</th>
                                <th style="width:80px;">Cheque #</th>
                                <th>Details</th>
                                <th>Category</th>
                                <th style="width:110px;">Deposit</th>
                                <th style="width:110px;">Payment</th>
                                <th style="width:120px;">Balance</th>
                                <th style="width:50px;" class="no-print">Act</th>
                            </tr>
                        </thead>
                        <tbody id="txnBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ====== BUDGET VS ACTUAL ====== -->
        <div id="page-budget" class="page">
            <div class="page-header">
                <div><h2>Budget vs Actual</h2><div class="subtitle">Line item comparison</div></div>
            </div>
            <div class="card" id="budgetCard"></div>
        </div>

        <!-- ====== CATEGORIES ====== -->
        <div id="page-categories" class="page">
            <div class="page-header">
                <div><h2>Category Breakdown</h2><div class="subtitle">Expenditure analysis by category</div></div>
            </div>
            <div class="charts-grid">
                <div class="card">
                    <div class="card-title">Category Distribution</div>
                    <div class="chart-container"><canvas id="chartCatPie"></canvas></div>
                </div>
                <div class="card" id="catTable"></div>
            </div>
        </div>

        <!-- ====== MONTHLY VIEW ====== -->
        <div id="page-monthly" class="page">
            <div class="page-header">
                <div><h2>Monthly Analysis</h2><div class="subtitle">Month-by-month breakdown</div></div>
            </div>
            <div class="stats-grid" id="monthlyStats"></div>
            <div class="card" id="monthlyDetail"></div>
        </div>

        <!-- ====== FINANCIAL DATA FORM ====== -->
        <div id="page-financial" class="page">
            <div class="page-header">
                <div><h2>Financial Data Collection Form</h2><div class="subtitle">CESTIS-Financial Management</div></div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="window.print()">üñ® Print Form</button>
                </div>
            </div>

            <div class="fin-summary">
                <div class="fin-box">
                    <h4>Subvention Summary</h4>
                    <div class="fin-line"><span>Opening Balance</span><span class="amount" id="fin-opening">$0</span></div>
                    <div class="fin-line"><span>Subvention Received</span><span class="amount positive" id="fin-subvention">$0</span></div>
                    <div class="fin-line"><span>Other Deposits</span><span class="amount">$0.00</span></div>
                    <div class="fin-line total"><span>Total Available</span><span class="amount" id="fin-total">$0</span></div>
                </div>
                <div class="fin-connector">‚Üí</div>
                <div class="fin-box">
                    <h4>Expenditure Summary</h4>
                    <div class="fin-line"><span>Amount Spent</span><span class="amount negative" id="fin-spent">$0</span></div>
                    <div class="fin-line"><span>Bank Charges</span><span class="amount negative" id="fin-bank">$0</span></div>
                    <div class="fin-line total"><span>Closing Balance</span><span class="amount" id="fin-closing">$0</span></div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìù Items of Recipient Expenses <span class="badge">Funded by HEART Subvention</span></div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Item</th><th style="width:140px;">Expenses ($)</th></tr></thead>
                        <tbody id="finItemsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ====== RECONCILIATION ====== -->
        <div id="page-reconciliation" class="page">
            <div class="page-header">
                <div><h2>Bank Reconciliation</h2><div class="subtitle">Cash book vs bank statement</div></div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showPageDirect('monthly-recon')">üìÖ Monthly Bank Reconciliation</button>
                </div>
            </div>
            <div class="card">
                <div class="card-title">üè¶ Quick Reconciliation View</div>
                <div class="form-grid" style="margin-bottom:1rem;">
                    <div class="form-group">
                        <label>Bank Statement Balance</label>
                        <input type="number" id="recon-bank" step="0.01" oninput="calcRecon()" placeholder="Enter bank balance">
                    </div>
                    <div class="form-group">
                        <label>Cash Book Balance</label>
                        <input type="number" id="recon-cashbook" step="0.01" readonly>
                    </div>
                    <div class="form-group">
                        <label>Difference</label>
                        <input type="text" id="recon-diff" readonly style="font-weight:700;">
                    </div>
                </div>
                <p style="font-size:.8125rem; color:var(--text3);">Enter the bank statement closing balance to see any reconciling items. Outstanding cheques and deposits in transit should explain any difference.</p>
            </div>

            <div class="card">
                <div class="card-title">üîñ Cheque Register Summary</div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Cheque #</th><th>Date</th><th>Payee</th><th>Amount</th><th>Status</th></tr></thead>
                        <tbody id="chequeRegBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ====== MONTHLY BANK RECONCILIATION ====== -->
        <div id="page-monthly-recon" class="page">
            <div class="page-header">
                <div><h2>Monthly Bank Reconciliation</h2><div class="subtitle">Month-by-month reconciliation across fiscal year quarters</div></div>
                <div class="header-actions">
                    <button class="btn btn-ghost" onclick="showPageDirect('reconciliation')">‚Üê Back to Reconciliation</button>
                </div>
            </div>

            <!-- FY Navigation -->
            <div class="recon-fy-nav">
                <button class="btn btn-ghost btn-sm" onclick="changeReconFY(-1)">‚óÄ Prev FY</button>
                <span class="recon-fy-label" id="reconFYLabel">FY 2025/2026</span>
                <button class="btn btn-ghost btn-sm" onclick="changeReconFY(1)">Next FY ‚ñ∂</button>
            </div>

            <!-- Month cards rendered dynamically by JS -->
            <div id="reconMonthCards"></div>

            <!-- Annual Summary -->
            <div class="card">
                <div class="card-title">üìä Fiscal Year Summary <span class="badge" id="reconFYSummaryLabel"></span></div>
                <div class="recon-summary-grid" id="reconFYSummary"></div>
            </div>
        </div>

        <!-- ====== BUDGET LINES ====== -->
        <div id="page-budgetlines" class="page">
            <div class="page-header">
                <div>
                    <h2>Budget Lines Manager</h2>
                    <div class="subtitle">All budget allocations synced with dashboard data</div>
                </div>
                <div class="header-actions">
                    <div class="budget-search-bar">
                        <span>üîç</span>
                        <input type="text" id="budgetLineSearch" placeholder="Search budget lines..." oninput="renderBudgetLinesPage()">
                    </div>
                    <button class="btn btn-success" onclick="openBudgetLineModal()">+ Add Line</button>
                </div>
            </div>

            <div class="budget-lines-grid">
                <div class="budget-summary-card card-blue">
                    <div class="budget-summary-label">Total Line Items</div>
                    <div class="budget-summary-value" id="totalBudgetItems">0</div>
                    <div class="budget-summary-sub">Active budget categories</div>
                </div>
                <div class="budget-summary-card card-purple">
                    <div class="budget-summary-label">Total Budgeted</div>
                    <div class="budget-summary-value" id="totalBudgetAmount">$0</div>
                    <div class="budget-summary-sub">Allocated this quarter</div>
                </div>
                <div class="budget-summary-card card-red">
                    <div class="budget-summary-label">Total Spent</div>
                    <div class="budget-summary-value" id="totalBudgetSpent">$0</div>
                    <div class="budget-summary-sub">Actual expenditure</div>
                </div>
                <div class="budget-summary-card card-green">
                    <div class="budget-summary-label">Total Variance</div>
                    <div class="budget-summary-value" id="totalBudgetVariance">$0</div>
                    <div class="budget-summary-sub">Remaining budget</div>
                </div>
            </div>

            <div class="card" style="padding:0;">
                <div id="budgetLinesList" class="budget-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>Loading budget lines...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Add/Edit Modal -->
<div class="modal-overlay" id="addModal">
    <div class="modal">
        <h3 id="modalTitle">Add Transaction</h3>
        <div class="form-grid">
            <div class="form-group"><label>Date</label><input type="date" id="m-date"></div>
            <div class="form-group"><label>Cheque #</label><input type="text" id="m-cheque" placeholder="e.g. 1000148"></div>
            <div class="form-group" style="grid-column:1/-1;"><label>Details</label><input type="text" id="m-details" placeholder="Description"></div>
            <div class="form-group"><label>Deposit ($)</label><input type="number" id="m-deposit" step="0.01" placeholder="0.00"></div>
            <div class="form-group"><label>Payment ($)</label><input type="number" id="m-payment" step="0.01" placeholder="0.00"></div>
            <div class="form-group"><label>Category</label>
                <select id="m-category"></select>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
            <button class="btn btn-success" onclick="saveTransaction()">Save</button>
        </div>
    </div>
</div>

<!-- Budget Line Edit Modal -->
<div class="modal-overlay budget-edit-modal" id="budgetLineModal">
    <div class="modal">
        <h3 id="budgetLineModalTitle">Add Budget Line</h3>
        <input type="hidden" id="bl-edit-key">
        <div class="form-grid">
            <div class="form-group" style="grid-column:1/-1;">
                <label>Category / Line Item Name</label>
                <input type="text" id="bl-name" placeholder="e.g., Admin Expenses">
            </div>
            <div class="form-group">
                <label>Budgeted Amount ($)</label>
                <input type="number" id="bl-amount" step="0.01" min="0" placeholder="0.00">
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost" onclick="closeBudgetLineModal()">Cancel</button>
            <button class="btn btn-success" onclick="saveBudgetLine()">Save</button>
        </div>
    </div>
</div>

<script>
// ============================================================
// CONFIGURATION: External Links
// ============================================================
const EXTERNAL_LINKS = {
    staffPayslip: 'https://stevebarrettsrha-ops.github.io/Staff-Payslip---Dashboard/',
    virementRequest: 'https://stevebarrettsrha-ops.github.io/CESTIS---Virement-Request/'
};

// ============================================================
// GOOGLE DRIVE CLOUD SYNC CONFIGURATION
// ============================================================
const GOOGLE_DRIVE_CONFIG = {
    CLIENT_ID: '302497466088-0b619cqa9qno2c606k4rqp742lebc5o8.apps.googleusercontent.com',
    FOLDER_ID: '1PEEMxF5M0V9ISihgnpGNUHeVSEQjgJG_',
    BACKUP_FILE_NAME: 'CESTIS_CASHBOOK_DASHBOARD_BACKUP.json',
    SCOPES: 'https://www.googleapis.com/auth/drive'
};

// Cloud sync state
let isCloudConnected = false;
let googleAccessToken = null;
let cloudFileId = localStorage.getItem('cestisCloudFileId') || null;
let lastSyncTime = localStorage.getItem('cestisLastSyncTime') ? new Date(localStorage.getItem('cestisLastSyncTime')) : null;
let lastSavedBy = null;
let cloudFileTimestamp = null;
let cloudSyncing = false;

// Google Token Client for OAuth (Google Identity Services)
let googleTokenClient = null;

// Staff members and time records for cloud merge
let staffMembers = JSON.parse(localStorage.getItem('cestisStaffMembers') || '[]');
let timeRecords = JSON.parse(localStorage.getItem('cestisTimeRecords') || '[]');

// Current user derived from auth session
let currentUser = null;

function initCurrentUser() {
    try {
        const session = JSON.parse(localStorage.getItem(AUTH_SESSION_KEY));
        if (session && session.loggedIn) {
            currentUser = {
                username: session.user,
                fullName: session.user === 'cestisadmin' ? 'CESTIS Admin' : session.user,
                role: 'Admin'
            };
        }
    } catch(e) {
        currentUser = null;
    }
}

// Save/load staff and time records
function saveStaffMembers() {
    try { localStorage.setItem('cestisStaffMembers', JSON.stringify(staffMembers)); } catch(e) {}
}
function saveTimeRecords() {
    try { localStorage.setItem('cestisTimeRecords', JSON.stringify(timeRecords)); } catch(e) {}
}

// ============================================
// Cloud Sync UI & Helper Functions
// ============================================

function setCloudSyncing(syncing) {
    cloudSyncing = syncing;
    const dot = document.getElementById('cloudStatusDot');
    const text = document.getElementById('cloudStatusText');
    const menuIcon = document.getElementById('cloudMenuIcon');

    if (syncing) {
        if (dot) dot.className = 'cloud-status-dot syncing';
        if (text) text.textContent = 'Syncing...';
        if (menuIcon) menuIcon.innerHTML = '<span class="spinning">üîÑ</span>';
    } else {
        if (dot) dot.className = 'cloud-status-dot' + (isCloudConnected ? ' connected' : '');
        if (text && isCloudConnected) text.textContent = 'Connected';
        if (menuIcon) menuIcon.textContent = '‚òÅÔ∏è';
    }
}

function updateCloudUI(connected) {
    if (connected !== undefined) isCloudConnected = connected;

    const notConnectedDiv = document.getElementById('cloudNotConnected');
    const connectedDiv = document.getElementById('cloudConnected');
    const statusDot = document.getElementById('cloudStatusDot');
    const statusText = document.getElementById('cloudStatusText');

    if (isCloudConnected) {
        if (notConnectedDiv) notConnectedDiv.style.display = 'none';
        if (connectedDiv) connectedDiv.style.display = 'block';
        if (statusDot) statusDot.className = 'cloud-status-dot connected';
        if (statusText) statusText.textContent = 'Connected';
    } else {
        if (notConnectedDiv) notConnectedDiv.style.display = 'block';
        if (connectedDiv) connectedDiv.style.display = 'none';
        if (statusDot) statusDot.className = 'cloud-status-dot';
        if (statusText) statusText.textContent = 'Not connected';
    }
    updateLastSyncDisplay();
}

function updateLastSyncDisplay() {
    const lastSyncInfo = document.getElementById('lastSyncInfo');
    const cloudSyncInfo = document.getElementById('cloudSyncInfo');
    if (lastSyncTime) {
        const timeAgo = getTimeAgo(lastSyncTime);
        if (lastSyncInfo) lastSyncInfo.textContent = 'Last sync: ' + timeAgo;
        if (cloudSyncInfo) {
            cloudSyncInfo.innerHTML = 'Last sync: ' + timeAgo;
            if (lastSavedBy) cloudSyncInfo.innerHTML += '<br>By: ' + lastSavedBy;
        }
    } else {
        if (lastSyncInfo) lastSyncInfo.textContent = 'Last sync: Never';
    }
}

function updateLastSavedByDisplay() {
    const lastSavedByInfo = document.getElementById('lastSavedByInfo');
    if (lastSavedByInfo) {
        if (lastSavedBy && cloudFileTimestamp) {
            const timeAgo = getTimeAgo(new Date(cloudFileTimestamp));
            lastSavedByInfo.textContent = 'Last saved by: ' + lastSavedBy + ' (' + timeAgo + ')';
        } else if (lastSavedBy) {
            lastSavedByInfo.textContent = 'Last saved by: ' + lastSavedBy;
        } else {
            lastSavedByInfo.textContent = 'Last saved by: --';
        }
    }
}

function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return diffMins + ' min' + (diffMins > 1 ? 's' : '') + ' ago';
    if (diffHours < 24) return diffHours + ' hour' + (diffHours > 1 ? 's' : '') + ' ago';
    return diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';
}

// Toggle cloud dropdown menu
function toggleCloudMenu() {
    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.toggle('show');

    setTimeout(function() {
        document.addEventListener('click', closeCloudMenuOnClickOutside);
    }, 0);
}

function closeCloudMenuOnClickOutside(e) {
    const menu = document.getElementById('cloudDropdownMenu');
    const dropdown = document.querySelector('.cloud-dropdown');

    if (!dropdown.contains(e.target)) {
        menu.classList.remove('show');
        document.removeEventListener('click', closeCloudMenuOnClickOutside);
    }
}

// Initialize cloud sync from localStorage
function initializeCloudSync() {
    const savedToken = localStorage.getItem('cestisGoogleAccessToken');
    const savedExpiry = localStorage.getItem('cestisGoogleTokenExpiry');
    const savedLastSync = localStorage.getItem('cestisLastSyncTime');
    const savedFileId = localStorage.getItem('cestisCloudFileId');

    if (savedLastSync) {
        lastSyncTime = new Date(savedLastSync);
        updateLastSyncDisplay();
    }

    if (savedFileId) {
        cloudFileId = savedFileId;
    }

    // Check if token is still valid
    if (savedToken && savedExpiry) {
        var expiry = new Date(savedExpiry);
        if (expiry > new Date()) {
            googleAccessToken = savedToken;
            isCloudConnected = true;
            updateCloudUI(true);
            return;
        }
    }

    updateCloudUI(false);
}

// ============================================
// Google Auth / Connect / Disconnect
// ============================================

function initGoogleAuth() {
    if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
        googleTokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
            scope: GOOGLE_DRIVE_CONFIG.SCOPES,
            callback: handleGoogleAuthCallback,
            error_callback: handleGoogleAuthError
        });
    }
}

async function connectToGoogleDrive() {
    showGoogleAuthModal();
}

function showGoogleAuthModal() {
    var modalHTML = '<div id="googleAuthModal" class="google-auth-modal" style="display: flex;">' +
        '<div class="modal-content" style="max-width: 560px;">' +
            '<div class="modal-header">' +
                '<h2>‚òÅÔ∏è Connect to Google Drive</h2>' +
                '<button class="close-btn" onclick="closeGoogleAuthModal()">&times;</button>' +
            '</div>' +
            '<div style="padding: 1.5rem;">' +
                '<p style="margin-bottom: 1.25rem; color: var(--text2);">Connect to Google Drive to save and sync your dashboard data across devices. Choose your preferred connection method:</p>' +

                '<!-- Option 1: Direct Google Sign-In -->' +
                '<div style="background: rgba(76, 175, 80, 0.1); border: 2px solid #4CAF50; border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;">' +
                    '<div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">' +
                        '<span style="font-size: 1.5rem;">üîê</span>' +
                        '<div>' +
                            '<strong style="color: #4CAF50; font-size: 1.1rem;">Direct Google Sign-In</strong>' +
                            '<span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem; font-weight: 600;">RECOMMENDED</span>' +
                        '</div>' +
                    '</div>' +
                    '<p style="color: var(--text2); font-size: 0.9rem; margin-bottom: 1rem;">A Google popup will appear for you to sign in with your Google account directly.</p>' +
                    '<button onclick="triggerDirectGoogleSignIn()" style="width: 100%; padding: 0.75rem; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">Sign in with Google</button>' +
                '</div>' +

                '<!-- Option 2: Manual Token Method -->' +
                '<div id="manualTokenSection" style="background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem;">' +
                    '<div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">' +
                        '<span style="font-size: 1.5rem;">üîß</span>' +
                        '<strong style="color: var(--text); font-size: 1.1rem;">Manual Token Method</strong>' +
                    '</div>' +
                    '<p style="color: var(--text2); font-size: 0.9rem; margin-bottom: 1rem;">If the popup doesn\'t work, you can use the OAuth Playground to get a token manually.</p>' +
                    '<button id="showManualTokenBtn" onclick="showManualTokenForm()" style="width: 100%; padding: 0.5rem; background: var(--surface); color: var(--text); border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">Use Manual Method</button>' +

                    '<div id="manualTokenForm" style="display: none; margin-top: 1rem;">' +
                        '<div style="background: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">' +
                            '<strong style="color: #2196F3;">How to get your access token:</strong>' +
                            '<ol style="margin-top: 0.5rem; margin-left: 1rem; color: var(--text2); font-size: 0.85rem; line-height: 1.6;">' +
                                '<li>Click the link below to open Google OAuth Playground</li>' +
                                '<li>In Step 1, find and select <strong>"Drive API v3"</strong> ‚Üí check <strong>"../auth/drive"</strong></li>' +
                                '<li>Click <strong>"Authorize APIs"</strong></li>' +
                                '<li>Sign in with your Google account</li>' +
                                '<li>In Step 2, click <strong>"Exchange authorization code for tokens"</strong></li>' +
                                '<li>Copy the <strong>"Access token"</strong> value and paste below</li>' +
                            '</ol>' +
                            '<a href="https://developers.google.com/oauthplayground" target="_blank" style="display: inline-block; margin-top: 0.75rem; padding: 0.5rem 1rem; background: #2196F3; color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 0.875rem;">üîó Open OAuth Playground</a>' +
                        '</div>' +
                        '<div style="margin-bottom: 1rem;">' +
                            '<label style="font-weight: 600; color: var(--text);">Access Token</label>' +
                            '<textarea id="googleAccessTokenInput" rows="4" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-family: var(--mono); font-size: 0.75rem; resize: vertical; margin-top: 0.5rem; background: var(--surface); color: var(--text);" placeholder="Paste your access token here..."></textarea>' +
                        '</div>' +
                        '<button onclick="submitGoogleToken()" style="width: 100%; padding: 0.75rem; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">‚òÅÔ∏è Connect with Token</button>' +
                    '</div>' +
                '</div>' +

                '<div style="margin-top: 1rem; text-align: center;">' +
                    '<button onclick="closeGoogleAuthModal()" style="padding: 0.5rem 1.5rem; background: var(--surface2); color: var(--text2); border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">Cancel</button>' +
                '</div>' +
            '</div>' +
        '</div>' +
    '</div>';

    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function triggerDirectGoogleSignIn() {
    closeGoogleAuthModal();
    if (googleTokenClient) {
        googleTokenClient.requestAccessToken();
    } else {
        initGoogleAuth();
        setTimeout(function() {
            if (googleTokenClient) {
                googleTokenClient.requestAccessToken();
            } else {
                alert('Google Sign-In popup is not available. Please use the manual token method.');
                showGoogleAuthModal();
                setTimeout(function() { showManualTokenForm(); }, 100);
            }
        }, 500);
    }
}

function showManualTokenForm() {
    var form = document.getElementById('manualTokenForm');
    var btn = document.getElementById('showManualTokenBtn');
    if (form && btn) {
        form.style.display = 'block';
        btn.style.display = 'none';
    }
}

function closeGoogleAuthModal() {
    var modal = document.getElementById('googleAuthModal');
    if (modal) modal.remove();
}

async function submitGoogleToken() {
    var tokenInput = document.getElementById('googleAccessTokenInput');
    var token = tokenInput.value.trim();

    if (!token) {
        alert('Please enter an access token');
        return;
    }

    try {
        var response = await fetch('https://www.googleapis.com/drive/v3/about?fields=user', {
            headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!response.ok) throw new Error('Invalid token');

        var data = await response.json();

        googleAccessToken = token;
        isCloudConnected = true;

        var expiry = new Date();
        expiry.setHours(expiry.getHours() + 1);
        localStorage.setItem('cestisGoogleAccessToken', token);
        localStorage.setItem('cestisGoogleTokenExpiry', expiry.toISOString());

        closeGoogleAuthModal();
        updateCloudUI(true);

        alert('Connected to Google Drive as ' + (data.user.displayName || data.user.emailAddress));
        await findExistingBackupFile();

    } catch (error) {
        console.error('Token verification failed:', error);
        alert('Invalid access token. Please make sure you copied the correct token.');
    }
}

async function handleGoogleAuthCallback(tokenResponse) {
    googleAccessToken = tokenResponse.access_token;
    isCloudConnected = true;

    var expiry = new Date();
    expiry.setSeconds(expiry.getSeconds() + (tokenResponse.expires_in || 3600));
    localStorage.setItem('cestisGoogleAccessToken', googleAccessToken);
    localStorage.setItem('cestisGoogleTokenExpiry', expiry.toISOString());

    updateCloudUI(true);
    await findExistingBackupFile();
}

function handleGoogleAuthError(error) {
    console.error('Google auth error:', error);
    if (error.type === 'popup_closed') return;
    alert('Failed to authenticate with Google. Please try the manual token method.');
    showGoogleAuthModal();
}

function disconnectFromGoogleDrive() {
    if (confirm('Are you sure you want to disconnect from Google Drive? Your local data will remain intact.')) {
        googleAccessToken = null;
        isCloudConnected = false;
        cloudFileId = null;

        localStorage.removeItem('cestisGoogleAccessToken');
        localStorage.removeItem('cestisGoogleTokenExpiry');
        localStorage.removeItem('cestisCloudFileId');

        updateCloudUI(false);

        var menu = document.getElementById('cloudDropdownMenu');
        if (menu) menu.classList.remove('show');

        alert('Disconnected from Google Drive');
    }
}

// ============================================
// Find Backup File & Conflict Detection
// ============================================

async function findExistingBackupFile() {
    if (!googleAccessToken) return;

    try {
        var query = "name='" + GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME + "' and '" + GOOGLE_DRIVE_CONFIG.FOLDER_ID + "' in parents and trashed=false";
        var response = await fetch(
            'https://www.googleapis.com/drive/v3/files?q=' + encodeURIComponent(query) + '&fields=files(id,name,modifiedTime)',
            { headers: { 'Authorization': 'Bearer ' + googleAccessToken } }
        );

        if (response.ok) {
            var data = await response.json();
            if (data.files && data.files.length > 0) {
                cloudFileId = data.files[0].id;
                cloudFileTimestamp = data.files[0].modifiedTime;
                localStorage.setItem('cestisCloudFileId', cloudFileId);
                console.log('Found existing backup file:', cloudFileId);
            }
        }
    } catch (error) {
        console.error('Error finding backup file:', error);
    }
}

async function checkCloudForChanges() {
    if (!cloudFileId || !googleAccessToken) return null;

    try {
        var response = await fetch(
            'https://www.googleapis.com/drive/v3/files/' + cloudFileId + '?alt=media',
            { headers: { 'Authorization': 'Bearer ' + googleAccessToken } }
        );

        if (response.ok) {
            var backupData = await response.json();
            return {
                savedBy: backupData.savedBy || 'Unknown',
                timestamp: backupData.timestamp
            };
        }
    } catch (error) {
        console.error('Error checking cloud for changes:', error);
    }
    return null;
}

// ============================================
// Prepare & Restore Backup Data
// ============================================

function prepareBackupData() {
    return {
        version: '1.0',
        timestamp: new Date().toISOString(),
        savedBy: currentUser ? currentUser.fullName : 'Unknown',
        data: {
            activeFY: activeFY,
            activeQ: activeQ,
            openingBalance: OPENING_BALANCE,
            transactions: transactions,
            budget: JSON.parse(JSON.stringify(BUDGET)),
            deletedBudgetKeys: typeof deletedBudgetKeys !== 'undefined' ? deletedBudgetKeys.slice() : [],
            staffMembers: staffMembers,
            timeRecords: timeRecords
        }
    };
}

function restoreBackupData(backupData) {
    if (!backupData || !backupData.data) return;
    var d = backupData.data;

    if (d.activeFY) activeFY = d.activeFY;
    if (d.activeQ) activeQ = d.activeQ;
    if (typeof d.openingBalance === 'number') OPENING_BALANCE = d.openingBalance;
    if (Array.isArray(d.transactions)) {
        transactions = d.transactions;
        nextId = transactions.reduce(function(max, t) { return Math.max(max, t.id + 1); }, 100);
    }
    if (d.budget && typeof d.budget === 'object') {
        BUDGET = d.budget;
        saveBudgetOverrides();
    }
    if (Array.isArray(d.deletedBudgetKeys)) {
        deletedBudgetKeys = d.deletedBudgetKeys;
        try { localStorage.setItem('cestis_budget_deleted', JSON.stringify(deletedBudgetKeys)); } catch(e) {}
    }
    if (Array.isArray(d.staffMembers)) {
        staffMembers = d.staffMembers;
        saveStaffMembers();
    }
    if (Array.isArray(d.timeRecords)) {
        timeRecords = d.timeRecords;
        saveTimeRecords();
    }

    // Save to localStorage
    saveToStorage();
    try { localStorage.setItem('cestis_active_quarter', JSON.stringify({ fy: activeFY, q: activeQ })); } catch(e) {}

    // Refresh UI
    updateQuarterUI();
    refreshAll();
}

// ============================================
// SAVE TO CLOUD
// ============================================

async function saveToCloud() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first');
        return;
    }

    var menu = document.getElementById('cloudDropdownMenu');
    if (menu) menu.classList.remove('show');

    // Check for changes by others before saving
    var cloudInfo = await checkCloudForChanges();

    var confirmMessage = 'MULTI-USER CLOUD SYNC\n\n';
    confirmMessage += 'You are about to save to a shared cloud backup.\n\n';

    if (cloudInfo && cloudInfo.savedBy) {
        var cloudTime = new Date(cloudInfo.timestamp);
        var timeSinceLastSave = getTimeAgo(cloudTime);

        var hasConflict = lastSyncTime && cloudTime > lastSyncTime;

        if (hasConflict && cloudInfo.savedBy !== (currentUser ? currentUser.username : '')) {
            confirmMessage += 'WARNING: ' + cloudInfo.savedBy + ' saved changes ' + timeSinceLastSave + '!\n';
            confirmMessage += 'Your local data may not include their changes.\n\n';
            confirmMessage += 'Recommendation: Click Cancel, then "Sync from Cloud" first.\n\n';
        } else {
            confirmMessage += 'Last saved by: ' + cloudInfo.savedBy + ' (' + timeSinceLastSave + ')\n\n';
        }
    }

    confirmMessage += 'This will overwrite the cloud backup. Continue?';

    if (!confirm(confirmMessage)) return;

    setCloudSyncing(true);

    try {
        var backupData = prepareBackupData();
        var jsonContent = JSON.stringify(backupData, null, 2);
        var blob = new Blob([jsonContent], { type: 'application/json' });

        var response;

        if (cloudFileId) {
            response = await fetch(
                'https://www.googleapis.com/upload/drive/v3/files/' + cloudFileId + '?uploadType=media',
                {
                    method: 'PATCH',
                    headers: {
                        'Authorization': 'Bearer ' + googleAccessToken,
                        'Content-Type': 'application/json'
                    },
                    body: blob
                }
            );
        } else {
            var metadata = {
                name: GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME,
                parents: [GOOGLE_DRIVE_CONFIG.FOLDER_ID],
                mimeType: 'application/json'
            };

            var formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            formData.append('file', blob);

            response = await fetch(
                'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name',
                {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + googleAccessToken },
                    body: formData
                }
            );

            if (response.ok) {
                var result = await response.json();
                cloudFileId = result.id;
                localStorage.setItem('cestisCloudFileId', cloudFileId);
            }
        }

        if (!response.ok) {
            var errorData = await response.json();
            throw new Error(errorData.error?.message || 'Upload failed');
        }

        lastSyncTime = new Date();
        localStorage.setItem('cestisLastSyncTime', lastSyncTime.toISOString());
        updateLastSyncDisplay();

        lastSavedBy = currentUser ? currentUser.fullName : 'Unknown';
        cloudFileTimestamp = new Date().toISOString();
        updateLastSavedByDisplay();

        setCloudSyncing(false);
        alert('Data saved to Google Drive successfully!\n\nSaved by: ' + lastSavedBy + '\n\nTip: Let other users know to sync from cloud to get your changes.');

    } catch (error) {
        console.error('Error saving to cloud:', error);
        setCloudSyncing(false);

        if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
            alert('Your session has expired. Please reconnect to Google Drive.');
            disconnectFromGoogleDrive();
        } else {
            alert('Failed to save to cloud: ' + error.message);
        }
    }
}

// ============================================
// SYNC FROM CLOUD (full replace)
// ============================================

async function syncFromCloud() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first');
        return;
    }

    var menu = document.getElementById('cloudDropdownMenu');
    if (menu) menu.classList.remove('show');

    if (!cloudFileId) {
        await findExistingBackupFile();
    }

    if (!cloudFileId) {
        alert('No backup file found in Google Drive. Save your data first to create a backup.');
        return;
    }

    if (!confirm('This will REPLACE your local data with the cloud backup. Are you sure you want to continue?')) {
        return;
    }

    setCloudSyncing(true);

    try {
        var response = await fetch(
            'https://www.googleapis.com/drive/v3/files/' + cloudFileId + '?alt=media',
            { headers: { 'Authorization': 'Bearer ' + googleAccessToken } }
        );

        if (!response.ok) throw new Error('Failed to download backup');

        var backupData = await response.json();

        if (!backupData.data || !backupData.version) {
            throw new Error('Invalid backup file format');
        }

        // Restore all data
        restoreBackupData(backupData);

        // Update sync info
        lastSyncTime = new Date();
        localStorage.setItem('cestisLastSyncTime', lastSyncTime.toISOString());
        updateLastSyncDisplay();

        lastSavedBy = backupData.savedBy || 'Unknown';
        cloudFileTimestamp = backupData.timestamp;
        updateLastSavedByDisplay();

        setCloudSyncing(false);

        var backupTime = new Date(backupData.timestamp).toLocaleString();
        var savedByInfo = backupData.savedBy ? '\nLast saved by: ' + backupData.savedBy : '';
        alert('Data synced from cloud successfully!\n\nBackup was created: ' + backupTime + savedByInfo);

    } catch (error) {
        console.error('Error syncing from cloud:', error);
        setCloudSyncing(false);

        if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
            alert('Your session has expired. Please reconnect to Google Drive.');
            disconnectFromGoogleDrive();
        } else {
            alert('Failed to sync from cloud: ' + error.message);
        }
    }
}

// ============================================
// MERGE FROM CLOUD (additive ‚Äî no data lost)
// ============================================

async function mergeFromCloud() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first');
        return;
    }

    var menu = document.getElementById('cloudDropdownMenu');
    if (menu) menu.classList.remove('show');

    if (!cloudFileId) {
        await findExistingBackupFile();
    }

    if (!cloudFileId) {
        alert('No backup file found in Google Drive. Save your data first to create a backup.');
        return;
    }

    if (!confirm('MERGE FROM CLOUD\n\nThis will merge cloud data with your local data:\n\n' +
        '- New transactions from cloud will be ADDED\n' +
        '- New budget lines from cloud will be ADDED\n' +
        '- New staff members from cloud will be ADDED\n' +
        '- Existing local items are preserved\n' +
        '- No local data will be removed\n\nContinue?')) {
        return;
    }

    setCloudSyncing(true);

    try {
        var response = await fetch(
            'https://www.googleapis.com/drive/v3/files/' + cloudFileId + '?alt=media',
            { headers: { 'Authorization': 'Bearer ' + googleAccessToken } }
        );

        if (!response.ok) throw new Error('Failed to download backup');

        var backupData = await response.json();

        if (!backupData.data || !backupData.version) {
            throw new Error('Invalid backup file format');
        }

        var d = backupData.data;
        var mergeStats = { transactionsAdded: 0, budgetLinesAdded: 0, staffAdded: 0, timeRecordsAdded: 0 };

        // Merge transactions ‚Äî add cloud transactions that don't exist locally (match by id)
        if (Array.isArray(d.transactions)) {
            var localTxnIds = new Set(transactions.map(function(t) { return t.id; }));
            d.transactions.forEach(function(cloudTxn) {
                if (!localTxnIds.has(cloudTxn.id)) {
                    transactions.push(cloudTxn);
                    mergeStats.transactionsAdded++;
                }
            });
            if (mergeStats.transactionsAdded > 0) {
                nextId = transactions.reduce(function(max, t) { return Math.max(max, t.id + 1); }, 100);
                saveToStorage();
            }
        }

        // Merge budget lines ‚Äî add cloud budget categories not present locally
        if (d.budget && typeof d.budget === 'object') {
            Object.keys(d.budget).forEach(function(cat) {
                if (BUDGET[cat] === undefined) {
                    BUDGET[cat] = d.budget[cat];
                    mergeStats.budgetLinesAdded++;
                }
            });
            if (mergeStats.budgetLinesAdded > 0) {
                saveBudgetOverrides();
            }
        }

        // Merge staff members ‚Äî add by name match (case-insensitive)
        if (Array.isArray(d.staffMembers)) {
            var localStaffNames = staffMembers.map(function(s) { return (s.name || '').toLowerCase(); });
            d.staffMembers.forEach(function(cloudStaff) {
                if (!localStaffNames.includes((cloudStaff.name || '').toLowerCase())) {
                    staffMembers.push(cloudStaff);
                    mergeStats.staffAdded++;
                }
            });
            if (mergeStats.staffAdded > 0) {
                saveStaffMembers();
            }
        }

        // Merge time records ‚Äî add by matching on a composite key (date + staffId/name)
        if (Array.isArray(d.timeRecords)) {
            var localRecordKeys = new Set(timeRecords.map(function(r) {
                return (r.date || '') + '|' + (r.staffId || r.name || '');
            }));
            d.timeRecords.forEach(function(cloudRecord) {
                var key = (cloudRecord.date || '') + '|' + (cloudRecord.staffId || cloudRecord.name || '');
                if (!localRecordKeys.has(key)) {
                    timeRecords.push(cloudRecord);
                    mergeStats.timeRecordsAdded++;
                }
            });
            if (mergeStats.timeRecordsAdded > 0) {
                saveTimeRecords();
            }
        }

        // Update sync info
        lastSyncTime = new Date();
        localStorage.setItem('cestisLastSyncTime', lastSyncTime.toISOString());
        updateLastSyncDisplay();

        lastSavedBy = backupData.savedBy || 'Unknown';
        cloudFileTimestamp = backupData.timestamp;
        updateLastSavedByDisplay();

        // Refresh UI
        refreshAll();

        setCloudSyncing(false);

        // Build summary message
        var summary = 'Merge from cloud completed!\n\n';
        summary += 'Merge Summary:\n';
        summary += '- Transactions added: ' + mergeStats.transactionsAdded + '\n';
        summary += '- Budget lines added: ' + mergeStats.budgetLinesAdded + '\n';
        summary += '- Staff members added: ' + mergeStats.staffAdded + '\n';
        summary += '- Time records added: ' + mergeStats.timeRecordsAdded + '\n';

        var totalAdded = mergeStats.transactionsAdded + mergeStats.budgetLinesAdded + mergeStats.staffAdded + mergeStats.timeRecordsAdded;
        if (totalAdded === 0) {
            summary += '\nNo new data found ‚Äî your local data already contains everything from the cloud.';
        } else {
            summary += '\nTip: Save to Cloud to push the merged data back for other users.';
        }

        var savedByInfo = backupData.savedBy ? '\nCloud backup was saved by: ' + backupData.savedBy : '';
        summary += savedByInfo;

        alert(summary);

    } catch (error) {
        console.error('Error merging from cloud:', error);
        setCloudSyncing(false);

        if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
            alert('Your session has expired. Please reconnect to Google Drive.');
            disconnectFromGoogleDrive();
        } else {
            alert('Failed to merge from cloud: ' + error.message);
        }
    }
}

// Browse backup files in Google Drive folder
function browseBackupFiles() {
    var menu = document.getElementById('cloudDropdownMenu');
    if (menu) menu.classList.remove('show');

    if (GOOGLE_DRIVE_CONFIG.FOLDER_ID) {
        window.open('https://drive.google.com/drive/folders/' + GOOGLE_DRIVE_CONFIG.FOLDER_ID, '_blank');
    }
}

// Stub render functions for compatibility
function renderStaffTable() { /* Staff table render - extend when staff management UI is added */ }
function renderTodayLog() { /* Today log render - extend when time tracking UI is added */ }
function renderHistory() { /* History render - extend when history UI is added */ }

// ============================================================
// QUARTER CONFIGURATION
// ============================================================
const QUARTER_META = [
    { q:1, label:'Q1 ¬∑ Apr‚ÄìJun', shortLabel:'Apr‚ÄìJun', months:['apr','may','jun'], monthNums:[4,5,6], monthNames:['April','May','June'] },
    { q:2, label:'Q2 ¬∑ Jul‚ÄìSep', shortLabel:'Jul‚ÄìSep', months:['jul','aug','sep'], monthNums:[7,8,9], monthNames:['July','August','September'] },
    { q:3, label:'Q3 ¬∑ Oct‚ÄìDec', shortLabel:'Oct‚ÄìDec', months:['oct','nov','dec'], monthNums:[10,11,12], monthNames:['October','November','December'] },
    { q:4, label:'Q4 ¬∑ Jan‚ÄìMar', shortLabel:'Jan‚ÄìMar', months:['jan','feb','mar'], monthNums:[1,2,3], monthNames:['January','February','March'] }
];

// Active quarter state
let activeFY = '2025/2026';
let activeQ = 3;

function getQuarterMeta(q) { return QUARTER_META.find(m => m.q === q); }
function getQuarterKey(fy, q) { return 'cestis_quarter_' + fy + '_Q' + q; }
function getCurrentQuarterKey() { return getQuarterKey(activeFY, activeQ); }

// Get the calendar year for a month in a fiscal quarter
function getCalendarYear(fy, q, monthIdx) {
    const startYear = parseInt(fy.split('/')[0]);
    // Q4 (Jan-Mar) is in the second year of the FY
    return q === 4 ? startYear + 1 : (q === 3 && monthIdx >= 10 ? startYear : startYear);
}

function getQuarterCalendarYear(fy, q) {
    const startYear = parseInt(fy.split('/')[0]);
    return q === 4 ? startYear + 1 : startYear;
}

function fyLabel(fy) { return 'FY ' + fy; }
function quarterPeriodLabel(fy, q) {
    const meta = getQuarterMeta(q);
    const yr = getQuarterCalendarYear(fy, q);
    return meta.shortLabel + ' ' + yr;
}

// ============================================================
// DATA: Pre-loaded from the Excel Cash Book Oct-Dec 2025
// ============================================================
let BUDGET = {
    'Coordinator Salary':345394.95, 'Asst. Coordinator':234000, 'Statutory Deductions':457490.66,
    'Admin Expenses':150000, 'Training Material':150000, 'Assessor Fees':250000,
    'Utilities':150000, 'Maintenance':150000,
    'Welding L3 Instructor':308091.99, 'Electrical L3 Instructor':308091.99,
    'Welding Instructor':287829.27, 'BT Instructor':287829.27, 'Electrical Instructor':287829.27,
    'BNV Welding Instructor':287829.27, 'BNV Electrical Instructor':287829.27,
    'Data Instructor':193800, 'Remedial English':193800, 'Personal Dev':0,
    'Entrep Instructor':193800, 'Math Instructor':193800,
    'Bank Charges':30000, 'Travelling':0, 'Lunch':0
};

let OPENING_BALANCE = 237948.69;

// Default transactions for Q3 FY 2025/2026
const DEFAULT_TRANSACTIONS_Q3 = [
    {id:1,date:'2025-10-06',cheque:'1000102',details:'Nakia Sterling (Ink Cartridge)',deposit:0,payment:120000,category:'Admin Expenses'},
    {id:2,date:'2025-10-16',cheque:'1000103',details:'Rohan Hamilton (Lunch Register)',deposit:0,payment:100000,category:'Lunch'},
    {id:3,date:'2025-10-25',cheque:'',details:'SUBVENTION',deposit:4509467.25,payment:0,category:'Subvention'},
    {id:4,date:'2025-10-25',cheque:'1000104',details:'Rohan Hamilton - Salary October',deposit:0,payment:89051.98,category:'Welding Instructor'},
    {id:5,date:'2025-10-25',cheque:'1000105',details:'Kevin Allen - Salary October',deposit:0,payment:89051.98,category:'BNV Welding Instructor'},
    {id:6,date:'2025-10-25',cheque:'1000106',details:'Peter Williams - Salary October',deposit:0,payment:89051.98,category:'Electrical Instructor'},
    {id:7,date:'2025-10-25',cheque:'1000107',details:'Melvin Barnes - Salary October',deposit:0,payment:89051.98,category:'BNV Electrical Instructor'},
    {id:8,date:'2025-10-25',cheque:'1000108',details:'Fontanette Whittingham - Salary October',deposit:0,payment:89051.98,category:'BT Instructor'},
    {id:9,date:'2025-10-25',cheque:'1000109',details:'Steve Barrett - Salary October',deposit:0,payment:106862.32,category:'Coordinator Salary'},
    {id:10,date:'2025-10-25',cheque:'1000110',details:'Rashaun Barrett - Salary October',deposit:0,payment:72397.65,category:'Asst. Coordinator'},
    {id:11,date:'2025-10-25',cheque:'',details:'BANK CHARGES',deposit:0,payment:1017.27,category:'Bank Charges'},
    {id:12,date:'2025-11-03',cheque:'1000111',details:'Markrys Enterprise Ltd.',deposit:0,payment:44898.30,category:'Admin Expenses'},
    {id:13,date:'2025-11-03',cheque:'1000112',details:'Rohan Hamilton (Travelling)',deposit:0,payment:21117.60,category:'Travelling'},
    {id:14,date:'2025-11-03',cheque:'1000113',details:'Dermain Jarrett (Maintenance)',deposit:0,payment:375000,category:'Maintenance'},
    {id:15,date:'2025-11-03',cheque:'1000114',details:'Nakia Sterling (Ink Cartridge - Colored & Maintenance)',deposit:0,payment:350000,category:'Admin Expenses'},
    {id:16,date:'2025-11-11',cheque:'1000115',details:'Rohan Hamilton (Lunch Register)',deposit:0,payment:400000,category:'Lunch'},
    {id:17,date:'2025-11-11',cheque:'1000116',details:'Tenesha Patterson (Communication Instructor)',deposit:0,payment:34477.06,category:'Remedial English'},
    {id:18,date:'2025-11-11',cheque:'1000117',details:'National Water Commission',deposit:0,payment:21792.91,category:'Utilities'},
    {id:19,date:'2025-11-11',cheque:'1000118',details:'Columbus Communication Ja Ltd.',deposit:0,payment:15981.44,category:'Utilities'},
    {id:20,date:'2025-11-11',cheque:'1000119',details:'Cancelled Cheque',deposit:0,payment:0,category:'Cancelled'},
    {id:21,date:'2025-11-11',cheque:'1000120',details:'Cancelled Cheque',deposit:0,payment:0,category:'Cancelled'},
    {id:22,date:'2025-11-17',cheque:'1000121',details:'Nakia Sterling (Maintenance)',deposit:0,payment:80000,category:'Maintenance'},
    {id:23,date:'2025-11-25',cheque:'1000122',details:'Steve Barrett - Salary November',deposit:0,payment:106862.32,category:'Coordinator Salary'},
    {id:24,date:'2025-11-25',cheque:'1000123',details:'Rashaun Barrett - Salary November',deposit:0,payment:72397.65,category:'Asst. Coordinator'},
    {id:25,date:'2025-11-25',cheque:'1000124',details:'Rohan Hamilton - Salary November',deposit:0,payment:89051.98,category:'Welding Instructor'},
    {id:26,date:'2025-11-25',cheque:'1000125',details:'Kevin Allen - Salary November',deposit:0,payment:89051.98,category:'BNV Welding Instructor'},
    {id:27,date:'2025-11-25',cheque:'1000126',details:'Peter Williams - Salary November',deposit:0,payment:89051.98,category:'Electrical Instructor'},
    {id:28,date:'2025-11-25',cheque:'1000127',details:'Melvin Barnes - Salary November',deposit:0,payment:89051.98,category:'BNV Electrical Instructor'},
    {id:29,date:'2025-11-25',cheque:'1000128',details:'Cancelled Cheque',deposit:0,payment:0,category:'Cancelled'},
    {id:30,date:'2025-11-25',cheque:'1000129',details:'Fontanette Whittingham - Salary November',deposit:0,payment:89051.98,category:'BT Instructor'},
    {id:31,date:'2025-11-25',cheque:'',details:'TAJ - Bank Transfer (Sep-Oct)',deposit:0,payment:298707.93,category:'Statutory Deductions'},
    {id:32,date:'2025-11-25',cheque:'',details:'TAJ - Bank Transfer (November)',deposit:0,payment:134539.29,category:'Statutory Deductions'},
    {id:33,date:'2025-11-25',cheque:'',details:'BANK CHARGES',deposit:0,payment:4.20,category:'Bank Charges'},
    {id:34,date:'2025-11-25',cheque:'1000130',details:'Cancelled Cheque',deposit:0,payment:0,category:'Cancelled'},
    {id:35,date:'2025-11-25',cheque:'1000131',details:'Steve Barrett (Travelling)',deposit:0,payment:36363.60,category:'Travelling'},
    {id:36,date:'2025-11-28',cheque:'1000132',details:'Rohan Campbell (Welding Plant Diagnostics)',deposit:0,payment:56000,category:'Maintenance'},
    {id:37,date:'2025-12-11',cheque:'1000133',details:'Rashaun Barrett (Salary Advance)',deposit:0,payment:47058.47,category:'Asst. Coordinator'},
    {id:38,date:'2025-12-11',cheque:'1000134',details:'Cancelled Cheque',deposit:0,payment:0,category:'Cancelled'},
    {id:39,date:'2025-12-11',cheque:'1000135',details:'Steve Barrett (Reimbursement)',deposit:0,payment:55809.50,category:'Admin Expenses'},
    {id:40,date:'2025-12-11',cheque:'1000136',details:'Tenesha Patterson (Entrep Instructor)',deposit:0,payment:119920.21,category:'Entrep Instructor'},
    {id:41,date:'2025-12-11',cheque:'1000137',details:'Kristof Williams (IT Instructor)',deposit:0,payment:119920.21,category:'Data Instructor'},
    {id:42,date:'2025-12-18',cheque:'1000138',details:'Steve Barrett - Salary December',deposit:0,payment:106862.32,category:'Coordinator Salary'},
    {id:43,date:'2025-12-18',cheque:'1000139',details:'Rashaun Barrett - Salary December (Advance Taken)',deposit:0,payment:25339.18,category:'Asst. Coordinator'},
    {id:44,date:'2025-12-18',cheque:'1000140',details:'Rohan Hamilton - Salary December',deposit:0,payment:89051.98,category:'Welding Instructor'},
    {id:45,date:'2025-12-18',cheque:'1000141',details:'Kevin Allen - Salary December',deposit:0,payment:89051.98,category:'BNV Welding Instructor'},
    {id:46,date:'2025-12-18',cheque:'1000142',details:'Peter Williams - Salary December',deposit:0,payment:89051.98,category:'Electrical Instructor'},
    {id:47,date:'2025-12-18',cheque:'1000143',details:'Melvin Barnes - Salary December',deposit:0,payment:89051.98,category:'BNV Electrical Instructor'},
    {id:48,date:'2025-12-18',cheque:'1000144',details:'Fontanette Whittingham - Salary December',deposit:0,payment:89051.98,category:'BT Instructor'},
    {id:49,date:'2025-12-18',cheque:'1000145',details:'Tenesha Patterson (Communication Instructor)',deposit:0,payment:71952.13,category:'Entrep Instructor'},
    {id:50,date:'2025-12-18',cheque:'1000146',details:'Kristof Williams (IT Instructor)',deposit:0,payment:71952.13,category:'Data Instructor'},
    {id:51,date:'2025-12-20',cheque:'1000147',details:'Rohan Hamilton (Lunch Register) - Replace Chq 1000134',deposit:0,payment:100000,category:'Lunch'},
    {id:52,date:'2025-12-20',cheque:'',details:'Tax Administration - December',deposit:0,payment:130565.96,category:'Statutory Deductions'},
    {id:53,date:'2025-12-22',cheque:'',details:'BANK CHARGES',deposit:0,payment:2070,category:'Bank Charges'},
];

let transactions = [];
let nextId = 100;
let currentFilter = 'all';
let chartInstances = {};

// ============================================================
// UTILITY FUNCTIONS
// ============================================================
function fmt(n) {
    return '$' + Math.abs(n).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
}
function fmtShort(n) {
    if (n >= 1000000) return '$' + (n/1000000).toFixed(1) + 'M';
    if (n >= 1000) return '$' + (n/1000).toFixed(0) + 'K';
    return '$' + n.toFixed(0);
}
const MONTH_KEYS = ['','jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
const MONTH_NAMES = {jan:'January',feb:'February',mar:'March',apr:'April',may:'May',jun:'June',
    jul:'July',aug:'August',sep:'September',oct:'October',nov:'November',dec:'December'};

function getMonth(d) {
    if (!d) return '';
    const m = parseInt(d.split('-')[1]);
    return MONTH_KEYS[m] || '';
}
function getMonthName(m) { return MONTH_NAMES[m] || m; }

function getCategoryTag(cat) {
    const map = {
        'Coordinator Salary':'tag-salary','Asst. Coordinator':'tag-salary',
        'Statutory Deductions':'tag-statutory','Admin Expenses':'tag-admin',
        'Maintenance':'tag-maintenance','Utilities':'tag-utility','Lunch':'tag-lunch',
        'Bank Charges':'tag-bank','Cancelled':'tag-cancelled','Travelling':'tag-travel',
        'Subvention':'tag-subvention',
    };
    return map[cat] || 'tag-instructor';
}

// ============================================================
// CALCULATIONS
// ============================================================
function calcTotals() {
    const qm = getQuarterMeta(activeQ);
    let totalDeposits = 0, totalPayments = 0;
    const catSpend = {};
    const monthSpend = {};
    const monthDeposit = {};
    qm.months.forEach(m => { monthSpend[m] = 0; monthDeposit[m] = 0; });
    const activeTxns = transactions.filter(t => t.category !== 'Cancelled');

    activeTxns.forEach(t => {
        totalDeposits += t.deposit;
        totalPayments += t.payment;
        if (t.payment > 0 && t.category !== 'Subvention') {
            catSpend[t.category] = (catSpend[t.category]||0) + t.payment;
        }
        const m = getMonth(t.date);
        if (m && monthSpend.hasOwnProperty(m)) {
            monthSpend[m] += t.payment;
            monthDeposit[m] += t.deposit;
        }
    });

    const totalAvailable = OPENING_BALANCE + totalDeposits;
    const closingBalance = OPENING_BALANCE + totalDeposits - totalPayments;
    const utilization = totalAvailable > 0 ? (totalPayments / totalAvailable * 100) : 0;

    return { totalDeposits, totalPayments, totalAvailable, closingBalance, utilization, catSpend, monthSpend, monthDeposit, activeTxns };
}

// ============================================================
// RENDER FUNCTIONS
// ============================================================
function renderDashboard() {
    const d = calcTotals();
    document.getElementById('dash-budget').textContent = fmt(d.totalAvailable);
    document.getElementById('dash-deposits').textContent = fmt(d.totalDeposits);
    document.getElementById('dash-spent').textContent = fmt(d.totalPayments);
    document.getElementById('dash-balance').textContent = fmt(d.closingBalance);
    document.getElementById('dash-util').textContent = d.utilization.toFixed(1) + '%';
    document.getElementById('dash-txn-count').textContent = d.activeTxns.filter(t=>t.payment>0).length + ' payments processed';
    // Update dynamic labels
    const period = quarterPeriodLabel(activeFY, activeQ);
    document.getElementById('dashSubtitle').textContent = 'Hazard STC ¬∑ Subvention Period: ' + period;
    document.getElementById('sidebarQuarterLabel').textContent = period + ' Quarter';

    renderCharts(d);
}

function renderTransactions() {
    const tbody = document.getElementById('txnBody');
    let balance = OPENING_BALANCE;
    const search = (document.getElementById('searchInput')?.value || '').toLowerCase();

    // Add opening balance row
    let html = `<tr class="deposit-row"><td></td><td></td><td><strong>BALANCE B/F</strong></td><td></td>
        <td class="amount positive">${fmt(OPENING_BALANCE)}</td><td></td>
        <td class="amount" style="font-weight:700;">${fmt(balance)}</td><td class="no-print"></td></tr>`;

    transactions.forEach(t => {
        balance += t.deposit - t.payment;
        const m = getMonth(t.date);

        const qm = getQuarterMeta(activeQ);
        if (currentFilter !== 'all' && m !== currentFilter && t.category !== 'Subvention') return;
        if (search && !t.details.toLowerCase().includes(search) && !(t.cheque||'').toLowerCase().includes(search) && !t.category.toLowerCase().includes(search)) return;

        const isCancelled = t.category === 'Cancelled';
        const isDeposit = t.deposit > 0;
        const isBank = t.category === 'Bank Charges';
        let rowClass = isCancelled ? 'cancelled' : isDeposit ? 'deposit-row' : isBank ? 'bank-charge' : '';

        html += `<tr class="${rowClass}">
            <td>${t.date ? t.date.substring(5) : ''}</td>
            <td class="cheque-num">${t.cheque||''}</td>
            <td>${t.details}</td>
            <td><span class="tag ${getCategoryTag(t.category)}">${t.category}</span></td>
            <td class="amount ${t.deposit>0?'positive':''}">${t.deposit>0?fmt(t.deposit):''}</td>
            <td class="amount ${t.payment>0?'negative':''}">${t.payment>0?fmt(t.payment):''}</td>
            <td class="amount" style="font-weight:600;">${fmt(balance)}</td>
            <td class="no-print"><button class="btn btn-danger btn-sm" onclick="deleteTxn(${t.id})">‚úï</button></td>
        </tr>`;
    });

    tbody.innerHTML = html;
}

function budgetPct(budgeted, actual) {
    if (budgeted <= 0 && actual <= 0) return { label: '-', barWidth: 0, barClass: 'under' };
    if (budgeted <= 0 && actual > 0) return { label: 'N/B', barWidth: 100, barClass: 'over' };
    var pct = actual / budgeted * 100;
    var barClass = pct > 110 ? 'over' : pct > 90 ? 'warning' : 'under';
    return { label: pct.toFixed(0) + '%', barWidth: Math.min(pct, 100), barClass: barClass };
}

function renderBudgetPage() {
    const d = calcTotals();
    let html = `<div class="card-title">üìä Budget Line Comparison <span class="badge">${Object.keys(BUDGET).length} line items</span></div>`;
    html += `<div class="budget-vs-actual-wrap"><table class="budget-vs-actual-table"><thead><tr>
        <th>Category</th><th class="col-right">Budgeted</th><th class="col-right">Actual</th><th class="col-right">Variance</th><th>%</th>
    </tr></thead><tbody>`;

    let totalBudget = 0, totalActual = 0;
    Object.keys(BUDGET).forEach(cat => {
        const budgeted = BUDGET[cat];
        const actual = d.catSpend[cat] || 0;
        const variance = budgeted - actual;
        const p = budgetPct(budgeted, actual);
        totalBudget += budgeted;
        totalActual += actual;

        html += `<tr>
            <td>${cat}</td>
            <td class="amount">${fmt(budgeted)}</td>
            <td class="amount">${actual > 0 ? fmt(actual) : '<span style="color:var(--text3)">-</span>'}</td>
            <td class="amount ${variance<0?'negative':'positive'}">${variance<0?'-':''}${fmt(Math.abs(variance))}</td>
            <td><div class="bar-cell"><div class="mini-bar"><div class="mini-bar-fill ${p.barClass}" style="width:${p.barWidth}%"></div></div><span style="font-size:.7rem;color:var(--text3)">${p.label}</span></div></td>
        </tr>`;
    });

    const tVar = totalBudget - totalActual;
    const tp = budgetPct(totalBudget, totalActual);
    html += `<tr class="total-row">
        <td><strong>TOTAL</strong></td><td class="amount">${fmt(totalBudget)}</td><td class="amount">${fmt(totalActual)}</td>
        <td class="amount ${tVar<0?'negative':'positive'}">${tVar<0?'-':''}${fmt(Math.abs(tVar))}</td>
        <td><div class="bar-cell"><div class="mini-bar"><div class="mini-bar-fill ${tp.barClass}" style="width:${tp.barWidth}%"></div></div><span style="font-size:.7rem;color:var(--text3)">${tp.label}</span></div></td>
    </tr>`;

    html += `</tbody></table></div>`;
    document.getElementById('budgetCard').innerHTML = html;
}

function renderCategoriesPage() {
    const d = calcTotals();
    const sorted = Object.entries(d.catSpend).filter(([k])=>k!=='Subvention').sort((a,b)=>b[1]-a[1]);
    const total = sorted.reduce((s,e)=>s+e[1],0);

    let html = `<div class="card-title">üè∑Ô∏è Category Ranking</div><div class="table-wrap"><table><thead><tr><th>#</th><th>Category</th><th class="amount">Amount</th><th class="amount">Share</th><th>Visual</th></tr></thead><tbody>`;
    sorted.forEach(([cat,amt],i) => {
        const pct = (amt/total*100);
        html += `<tr><td style="color:var(--text3)">${i+1}</td><td><span class="tag ${getCategoryTag(cat)}">${cat}</span></td>
            <td class="amount">${fmt(amt)}</td><td class="amount">${pct.toFixed(1)}%</td>
            <td><div class="mini-bar" style="width:200px;"><div class="mini-bar-fill under" style="width:${pct}%;background:var(--accent);"></div></div></td></tr>`;
    });
    html += `</tbody></table></div>`;
    document.getElementById('catTable').innerHTML = html;

    // Pie chart
    destroyChart('chartCatPie');
    const top8 = sorted.slice(0,8);
    const otherAmt = sorted.slice(8).reduce((s,e)=>s+e[1],0);
    const labels = top8.map(e=>e[0]);
    const data = top8.map(e=>e[1]);
    if (otherAmt > 0) { labels.push('Other'); data.push(otherAmt); }

    chartInstances['chartCatPie'] = new Chart(document.getElementById('chartCatPie'), {
        type:'doughnut', data:{labels, datasets:[{data, backgroundColor:['#3b82f6','#22c55e','#f59e0b','#ef4444','#a855f7','#14b8a6','#ec4899','#fb923c','#6366f1'], borderWidth:0}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#9ba3bf',font:{size:11}}}}}
    });
}

function renderMonthlyPage() {
    const d = calcTotals();
    const qm = getQuarterMeta(activeQ);
    const yr = getQuarterCalendarYear(activeFY, activeQ);
    const cardColors = ['blue','green','amber'];
    let html = '';
    qm.months.forEach((m,i) => {
        const spent = d.monthSpend[m] || 0;
        const dep = d.monthDeposit[m] || 0;
        html += `<div class="stat-card ${cardColors[i]}">
            <div class="label">${getMonthName(m)} ${yr}</div>
            <div class="value red-text">${fmt(spent)}</div>
            <div class="change">Deposits: ${fmt(dep)}</div></div>`;
    });
    document.getElementById('monthlyStats').innerHTML = html;

    // Monthly detail table
    let detail = `<div class="card-title">üìÖ Monthly Category Breakdown</div><div class="table-wrap"><table><thead><tr><th>Category</th>`;
    qm.monthNames.forEach(mn => { detail += `<th class="amount">${mn}</th>`; });
    detail += `<th class="amount">Total</th></tr></thead><tbody>`;
    const allCats = [...new Set(transactions.filter(t=>t.category!=='Cancelled'&&t.category!=='Subvention'&&t.payment>0).map(t=>t.category))];
    allCats.sort().forEach(cat => {
        const mAmts = qm.months.map(m => transactions.filter(t=>getMonth(t.date)===m&&t.category===cat).reduce((s,t)=>s+t.payment,0));
        const tot = mAmts.reduce((s,a)=>s+a,0);
        if (tot > 0) {
            detail += `<tr><td><span class="tag ${getCategoryTag(cat)}">${cat}</span></td>`;
            mAmts.forEach(a => { detail += `<td class="amount">${a?fmt(a):'-'}</td>`; });
            detail += `<td class="amount" style="font-weight:700">${fmt(tot)}</td></tr>`;
        }
    });
    detail += `</tbody></table></div>`;
    document.getElementById('monthlyDetail').innerHTML = detail;
}

function renderFinancialForm() {
    const d = calcTotals();
    document.getElementById('fin-opening').textContent = fmt(OPENING_BALANCE);
    document.getElementById('fin-subvention').textContent = fmt(d.totalDeposits);
    document.getElementById('fin-total').textContent = fmt(d.totalAvailable);
    document.getElementById('fin-spent').textContent = fmt(d.totalPayments);
    document.getElementById('fin-bank').textContent = fmt(d.catSpend['Bank Charges']||0);
    document.getElementById('fin-closing').textContent = fmt(d.closingBalance);

    // Items table - show all BUDGET categories with their actual spending
    let html = '';
    let total = 0;
    const shownCats = new Set();

    // First show all BUDGET categories (sorted by actual spend descending, then alphabetically)
    const budgetEntries = Object.keys(BUDGET).map(cat => {
        const amt = d.catSpend[cat] || 0;
        return [cat, amt];
    }).sort((a,b) => b[1] - a[1] || a[0].localeCompare(b[0]));

    budgetEntries.forEach(([cat, amt]) => {
        shownCats.add(cat);
        html += `<tr><td>${cat.toUpperCase()}</td><td class="amount">${amt > 0 ? fmt(amt) : '<span style="color:var(--text3)">$0.00</span>'}</td></tr>`;
        total += amt;
    });

    // Then show any transaction categories not in BUDGET (unbudgeted spending)
    Object.entries(d.catSpend).filter(([k]) => k !== 'Subvention' && !shownCats.has(k)).sort((a,b) => b[1] - a[1]).forEach(([cat, amt]) => {
        html += `<tr><td>${cat.toUpperCase()} <span style="font-size:.65rem;color:var(--amber);">(UNBUDGETED)</span></td><td class="amount negative">${fmt(amt)}</td></tr>`;
        total += amt;
    });

    html += `<tr style="font-weight:700;background:var(--surface2);"><td>TOTAL</td><td class="amount">${fmt(total)}</td></tr>`;
    document.getElementById('finItemsBody').innerHTML = html;
}

function renderReconciliation() {
    const d = calcTotals();
    document.getElementById('recon-cashbook').value = d.closingBalance.toFixed(2);

    // Auto-recalculate difference if bank balance was previously entered
    calcRecon();

    // Cheque register
    const cheques = transactions.filter(t => t.cheque);
    let html = '';
    cheques.forEach(t => {
        const status = t.category === 'Cancelled' ? '<span class="tag tag-cancelled">VOID</span>' : '<span class="tag tag-salary">Issued</span>';
        html += `<tr class="${t.category==='Cancelled'?'cancelled':''}">
            <td class="cheque-num">${t.cheque}</td><td>${t.date||''}</td><td>${t.details}</td>
            <td class="amount">${t.payment>0?fmt(t.payment):'-'}</td><td>${status}</td></tr>`;
    });
    document.getElementById('chequeRegBody').innerHTML = html;
}

function calcRecon() {
    const bank = parseFloat(document.getElementById('recon-bank').value) || 0;
    const cb = parseFloat(document.getElementById('recon-cashbook').value) || 0;
    const diff = bank - cb;
    const el = document.getElementById('recon-diff');
    el.value = (diff >= 0 ? '' : '-') + fmt(Math.abs(diff));
    el.style.color = Math.abs(diff) < 1 ? 'var(--green)' : 'var(--red)';
}

// ============================================================
// CHARTS
// ============================================================
function destroyChart(id) { if (chartInstances[id]) { chartInstances[id].destroy(); delete chartInstances[id]; } }

function renderCharts(d) {
    const colors = {bg:'#9ba3bf', grid:'#222842'};
    Chart.defaults.color = colors.bg;
    Chart.defaults.borderColor = colors.grid;

    // Category Doughnut
    destroyChart('chartCategory');
    const catEntries = Object.entries(d.catSpend).filter(([k])=>k!=='Subvention').sort((a,b)=>b[1]-a[1]).slice(0,10);
    chartInstances['chartCategory'] = new Chart(document.getElementById('chartCategory'), {
        type:'doughnut',
        data:{labels:catEntries.map(e=>e[0]), datasets:[{data:catEntries.map(e=>e[1]),
            backgroundColor:['#3b82f6','#22c55e','#f59e0b','#ef4444','#a855f7','#14b8a6','#ec4899','#fb923c','#6366f1','#84cc16'], borderWidth:0}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#9ba3bf',font:{size:10},boxWidth:12}}}}
    });

    // Monthly Bar
    destroyChart('chartMonthly');
    const qm = getQuarterMeta(activeQ);
    chartInstances['chartMonthly'] = new Chart(document.getElementById('chartMonthly'), {
        type:'bar',
        data:{labels:qm.monthNames, datasets:[
            {label:'Expenditure',data:qm.months.map(m=>d.monthSpend[m]||0),backgroundColor:'#ef4444',borderRadius:4},
            {label:'Deposits',data:qm.months.map(m=>d.monthDeposit[m]||0),backgroundColor:'#22c55e',borderRadius:4}
        ]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#9ba3bf',font:{size:11}}}},
            scales:{y:{ticks:{callback:v=>fmtShort(v)},grid:{color:'#222842'}},x:{grid:{display:false}}}}
    });

    // Running Balance Line
    destroyChart('chartBalance');
    let bal = OPENING_BALANCE;
    const balData = [{x:'B/F',y:bal}];
    transactions.filter(t=>t.category!=='Cancelled').forEach(t => {
        bal += t.deposit - t.payment;
        balData.push({x:t.date?t.date.substring(5):'', y:bal});
    });
    chartInstances['chartBalance'] = new Chart(document.getElementById('chartBalance'), {
        type:'line',
        data:{labels:balData.map(b=>b.x), datasets:[{label:'Balance',data:balData.map(b=>b.y),
            borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.08)',fill:true,tension:.3,pointRadius:1,borderWidth:2}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
            scales:{y:{ticks:{callback:v=>fmtShort(v)},grid:{color:'#222842'}},x:{display:false}}}
    });

    // Budget vs Actual Horizontal Bar
    destroyChart('chartBudgetVsActual');
    const topBudget = Object.entries(BUDGET).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]);
    const budgetChartContainer = document.getElementById('chartBudgetVsActual').parentElement;
    budgetChartContainer.style.height = Math.max(280, topBudget.length * 32) + 'px';
    chartInstances['chartBudgetVsActual'] = new Chart(document.getElementById('chartBudgetVsActual'), {
        type:'bar',
        data:{labels:topBudget.map(e=>e[0].length>18?e[0].substring(0,18)+'‚Ä¶':e[0]),
            datasets:[
                {label:'Budget',data:topBudget.map(e=>e[1]),backgroundColor:'rgba(59,130,246,0.3)',borderColor:'#3b82f6',borderWidth:1,borderRadius:3},
                {label:'Actual',data:topBudget.map(e=>d.catSpend[e[0]]||0),backgroundColor:'rgba(239,68,68,0.5)',borderColor:'#ef4444',borderWidth:1,borderRadius:3}
            ]},
        options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{labels:{color:'#9ba3bf',font:{size:10}}}},
            scales:{x:{ticks:{callback:v=>fmtShort(v)},grid:{color:'#222842'}},y:{grid:{display:false},ticks:{font:{size:10}}}}}
    });
}

// ============================================================
// CRUD
// ============================================================
function populateCategoryDropdown() {
    const sel = document.getElementById('m-category');
    const current = sel.value;
    sel.innerHTML = '';
    const cats = Object.keys(BUDGET).sort();
    cats.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        sel.appendChild(opt);
    });
    // Add standard extras
    ['Subvention','Cancelled','Other'].forEach(extra => {
        if (!BUDGET.hasOwnProperty(extra)) {
            const opt = document.createElement('option');
            opt.value = extra;
            opt.textContent = extra;
            sel.appendChild(opt);
        }
    });
    if (current && [...sel.options].some(o => o.value === current)) {
        sel.value = current;
    }
}

function openAddModal() {
    document.getElementById('modalTitle').textContent = 'Add Transaction';
    ['m-date','m-cheque','m-details','m-deposit','m-payment'].forEach(id=>document.getElementById(id).value='');
    populateCategoryDropdown();
    document.getElementById('m-category').value = 'Admin Expenses';
    document.getElementById('addModal').classList.add('show');
}
function closeModal() { document.getElementById('addModal').classList.remove('show'); }

function saveTransaction() {
    const t = {
        id: nextId++,
        date: document.getElementById('m-date').value,
        cheque: document.getElementById('m-cheque').value,
        details: document.getElementById('m-details').value,
        deposit: parseFloat(document.getElementById('m-deposit').value) || 0,
        payment: parseFloat(document.getElementById('m-payment').value) || 0,
        category: document.getElementById('m-category').value
    };
    if (!t.details) { alert('Please enter details'); return; }
    transactions.push(t);
    closeModal();
    refreshAll();
    saveToStorage();
}

function deleteTxn(id) {
    if (!confirm('Delete this transaction?')) return;
    transactions = transactions.filter(t=>t.id!==id);
    refreshAll();
    saveToStorage();
}

// ============================================================
// VOID CHEQUE
// ============================================================
function populateVoidDropdown() {
    const sel = document.getElementById('voidChequeSelect');
    const search = (document.getElementById('voidChequeSearch')?.value || '').toLowerCase();
    if (!sel) return;

    sel.innerHTML = '';
    const active = transactions.filter(t => t.category !== 'Cancelled' && (t.cheque || t.payment > 0 || t.deposit > 0));

    const filtered = search
        ? active.filter(t =>
            (t.cheque||'').toLowerCase().includes(search) ||
            t.details.toLowerCase().includes(search) ||
            t.category.toLowerCase().includes(search))
        : active;

    filtered.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        const chequeLabel = t.cheque ? 'Chq #' + t.cheque : 'No Chq#';
        const amtLabel = t.payment > 0 ? fmt(t.payment) : (t.deposit > 0 ? '+' + fmt(t.deposit) : '$0.00');
        opt.textContent = chequeLabel + '  |  ' + t.details + '  |  ' + amtLabel;
        sel.appendChild(opt);
    });

    // Update void count badge
    const voidedCount = transactions.filter(t => t.category === 'Cancelled').length;
    const badge = document.getElementById('voidCountBadge');
    if (badge) badge.textContent = voidedCount + ' voided';

    // Reset preview and button
    document.getElementById('voidPreview').classList.remove('show');
    document.getElementById('voidBtn').disabled = true;
}

function filterVoidDropdown() {
    populateVoidDropdown();
}

function previewVoidCheque() {
    const sel = document.getElementById('voidChequeSelect');
    const id = parseInt(sel.value);
    const t = transactions.find(tx => tx.id === id);
    const preview = document.getElementById('voidPreview');
    const btn = document.getElementById('voidBtn');

    if (!t) {
        preview.classList.remove('show');
        btn.disabled = true;
        return;
    }

    document.getElementById('voidPreviewDate').textContent = t.date || '-';
    document.getElementById('voidPreviewCheque').textContent = t.cheque || 'N/A';
    document.getElementById('voidPreviewDetails').textContent = t.details;
    document.getElementById('voidPreviewAmount').textContent = t.payment > 0 ? fmt(t.payment) : (t.deposit > 0 ? fmt(t.deposit) : '$0.00');
    document.getElementById('voidPreviewCategory').textContent = t.category;

    preview.classList.add('show');
    btn.disabled = false;
}

function voidSelectedCheque() {
    const sel = document.getElementById('voidChequeSelect');
    const id = parseInt(sel.value);
    const t = transactions.find(tx => tx.id === id);

    if (!t) { alert('Please select a transaction to void.'); return; }

    const label = t.cheque ? 'Cheque #' + t.cheque : t.details;
    if (!confirm('Void "' + label + '"?\n\nThis will mark it as Cancelled Cheque. The payment amount will be zeroed out and the category will change to Cancelled.\n\nThis action can be seen across all dashboards and in the reconciliation cheque register.')) {
        return;
    }

    // Store original values for potential unvoid
    t._origDetails = t.details;
    t._origCategory = t.category;
    t._origPayment = t.payment;
    t._origDeposit = t.deposit;

    // Void the cheque: set to cancelled, zero out amounts, update details
    t.details = 'Cancelled Cheque' + (t.cheque ? '' : ' (' + t.details + ')');
    t.category = 'Cancelled';
    t.payment = 0;
    t.deposit = 0;

    saveToStorage();
    refreshAll();

    // Clear the search and reset
    document.getElementById('voidChequeSearch').value = '';
}

// ============================================================
// UNVOID CHEQUE
// ============================================================
function populateUnvoidDropdown() {
    const sel = document.getElementById('unvoidChequeSelect');
    const search = (document.getElementById('unvoidChequeSearch')?.value || '').toLowerCase();
    if (!sel) return;

    sel.innerHTML = '';
    const voided = transactions.filter(t => t.category === 'Cancelled');

    const filtered = search
        ? voided.filter(t =>
            (t.cheque||'').toLowerCase().includes(search) ||
            t.details.toLowerCase().includes(search) ||
            (t._origDetails||'').toLowerCase().includes(search) ||
            (t._origCategory||'').toLowerCase().includes(search))
        : voided;

    filtered.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        const chequeLabel = t.cheque ? 'Chq #' + t.cheque : 'No Chq#';
        const origInfo = t._origDetails ? t._origDetails : t.details;
        const restorable = t._origPayment != null ? ' [restorable]' : ' [manual void]';
        opt.textContent = chequeLabel + '  |  ' + origInfo + restorable;
        sel.appendChild(opt);
    });

    // Reset preview and button
    const preview = document.getElementById('unvoidPreview');
    if (preview) preview.classList.remove('show');
    const btn = document.getElementById('unvoidBtn');
    if (btn) btn.disabled = true;
}

function filterUnvoidDropdown() {
    populateUnvoidDropdown();
}

function previewUnvoidCheque() {
    const sel = document.getElementById('unvoidChequeSelect');
    const id = parseInt(sel.value);
    const t = transactions.find(tx => tx.id === id);
    const preview = document.getElementById('unvoidPreview');
    const btn = document.getElementById('unvoidBtn');

    if (!t) {
        preview.classList.remove('show');
        btn.disabled = true;
        return;
    }

    document.getElementById('unvoidPreviewDate').textContent = t.date || '-';
    document.getElementById('unvoidPreviewCheque').textContent = t.cheque || 'N/A';

    if (t._origDetails != null) {
        document.getElementById('unvoidPreviewDetails').textContent = t._origDetails;
        const origAmt = t._origPayment > 0 ? fmt(t._origPayment) : (t._origDeposit > 0 ? fmt(t._origDeposit) : '$0.00');
        document.getElementById('unvoidPreviewAmount').textContent = origAmt;
        document.getElementById('unvoidPreviewCategory').textContent = t._origCategory;
        btn.disabled = false;
    } else {
        document.getElementById('unvoidPreviewDetails').textContent = t.details + ' (no original data stored)';
        document.getElementById('unvoidPreviewAmount').textContent = 'N/A';
        document.getElementById('unvoidPreviewCategory').textContent = 'N/A';
        btn.disabled = true;
    }

    preview.classList.add('show');
}

function unvoidSelectedCheque() {
    const sel = document.getElementById('unvoidChequeSelect');
    const id = parseInt(sel.value);
    const t = transactions.find(tx => tx.id === id);

    if (!t) { alert('Please select a voided transaction to restore.'); return; }

    if (t._origPayment == null) {
        alert('This transaction was voided before unvoid support was added. Original data is not available for automatic restoration.\n\nYou can manually re-create this transaction using the Add Entry button.');
        return;
    }

    const label = t.cheque ? 'Cheque #' + t.cheque : t._origDetails;
    if (!confirm('Unvoid "' + label + '"?\n\nThis will restore the original details, category, and amount.\n\nOriginal: ' + t._origDetails + ' | ' + t._origCategory + ' | ' + fmt(t._origPayment > 0 ? t._origPayment : t._origDeposit))) {
        return;
    }

    // Restore original values
    t.details = t._origDetails;
    t.category = t._origCategory;
    t.payment = t._origPayment;
    t.deposit = t._origDeposit;

    // Clean up stored originals
    delete t._origDetails;
    delete t._origCategory;
    delete t._origPayment;
    delete t._origDeposit;

    saveToStorage();
    refreshAll();

    // Clear the search and reset
    document.getElementById('unvoidChequeSearch').value = '';
}

// ============================================================
// FILTERS & NAVIGATION
// ============================================================
function showPage(page) {
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById('page-'+page).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    event.currentTarget.classList.add('active');
    refreshAll();
}

function openExternalLink(linkKey) {
    const url = EXTERNAL_LINKS[linkKey];
    if (url) {
        window.open(url, '_blank', 'noopener,noreferrer');
    }
}

function filterMonth(m, el) {
    currentFilter = m;
    document.querySelectorAll('#monthTabsContainer .month-tab').forEach(t=>t.classList.remove('active'));
    if (el) el.classList.add('active');
    renderTransactions();
}

function filterTransactions() { renderTransactions(); }

function refreshAll() {
    renderDashboard();
    renderTransactions();
    renderBudgetPage();
    renderCategoriesPage();
    renderMonthlyPage();
    renderFinancialForm();
    renderReconciliation();
    renderBudgetLinesPage();
    populateVoidDropdown();
    populateUnvoidDropdown();
    populateSubventionFields();
    renderMonthTabs();
}

// ============================================================
// BUDGET LINES MANAGEMENT (Synced with Dashboard BUDGET data)
// ============================================================

// Load any user-customized budget overrides from localStorage
function loadBudgetOverrides() {
    try {
        const saved = localStorage.getItem('cestis_budget_overrides');
        if (saved) {
            const overrides = JSON.parse(saved);
            // Apply overrides: add new keys, update changed amounts, remove deleted keys
            Object.keys(overrides).forEach(key => {
                BUDGET[key] = overrides[key];
            });
            // Remove keys that were deleted by user
            const deletedKeys = localStorage.getItem('cestis_budget_deleted');
            if (deletedKeys) {
                JSON.parse(deletedKeys).forEach(key => {
                    delete BUDGET[key];
                });
            }
        }
    } catch(e) {}
}

function saveBudgetOverrides() {
    localStorage.setItem('cestis_budget_overrides', JSON.stringify(BUDGET));
}

function saveBudgetDeletions(deletedKeys) {
    localStorage.setItem('cestis_budget_deleted', JSON.stringify(deletedKeys));
}

// Track deleted keys
let deletedBudgetKeys = [];
function loadDeletedBudgetKeys() {
    try {
        const saved = localStorage.getItem('cestis_budget_deleted');
        if (saved) { deletedBudgetKeys = JSON.parse(saved); }
    } catch(e) {}
}

// Modal controls
function openBudgetLineModal(editKey) {
    const modal = document.getElementById('budgetLineModal');
    const titleEl = document.getElementById('budgetLineModalTitle');
    const keyInput = document.getElementById('bl-edit-key');
    const nameInput = document.getElementById('bl-name');
    const amountInput = document.getElementById('bl-amount');

    if (editKey) {
        titleEl.textContent = 'Edit Budget Line';
        keyInput.value = editKey;
        nameInput.value = editKey;
        amountInput.value = BUDGET[editKey] || 0;
    } else {
        titleEl.textContent = 'Add Budget Line';
        keyInput.value = '';
        nameInput.value = '';
        amountInput.value = '';
    }
    modal.classList.add('show');
    nameInput.focus();
}

function closeBudgetLineModal() {
    document.getElementById('budgetLineModal').classList.remove('show');
}

function saveBudgetLine() {
    const editKey = document.getElementById('bl-edit-key').value;
    const name = document.getElementById('bl-name').value.trim();
    const amount = parseFloat(document.getElementById('bl-amount').value);

    if (!name) { alert('Please enter a line item name.'); return; }
    if (isNaN(amount) || amount < 0) { alert('Please enter a valid amount.'); return; }

    if (editKey) {
        // Editing existing line
        if (editKey !== name) {
            // Name changed - delete old key, create new
            if (BUDGET.hasOwnProperty(name) && name !== editKey) {
                alert('A budget line with that name already exists.');
                return;
            }
            delete BUDGET[editKey];
            // Update transactions that reference old category
            transactions.forEach(t => {
                if (t.category === editKey) t.category = name;
            });
            saveToStorage();
        }
        BUDGET[name] = amount;
    } else {
        // Adding new line
        if (BUDGET.hasOwnProperty(name)) {
            alert('A budget line with that name already exists. Please use a different name or edit the existing one.');
            return;
        }
        BUDGET[name] = amount;
    }

    // Remove from deleted list if it was previously deleted
    deletedBudgetKeys = deletedBudgetKeys.filter(k => k !== name);
    saveBudgetDeletions(deletedBudgetKeys);
    saveBudgetOverrides();
    closeBudgetLineModal();
    refreshAll();
}

function deleteBudgetLine(key) {
    if (!confirm('Delete "' + key + '" from budget lines?\n\nThis will remove it from all dashboards. Existing transactions in this category will remain but no budget will be tracked for them.')) {
        return;
    }
    delete BUDGET[key];
    deletedBudgetKeys.push(key);
    saveBudgetDeletions(deletedBudgetKeys);
    saveBudgetOverrides();
    refreshAll();
}

function renderBudgetLinesPage() {
    const listEl = document.getElementById('budgetLinesList');
    if (!listEl) return;

    const d = calcTotals();
    const search = (document.getElementById('budgetLineSearch')?.value || '').toLowerCase();

    // Build combined list from BUDGET object
    const entries = Object.keys(BUDGET).map(key => {
        const budgeted = BUDGET[key];
        const actual = d.catSpend[key] || 0;
        const variance = budgeted - actual;
        const pct = budgeted > 0 ? (actual / budgeted * 100) : (actual > 0 ? 999 : 0);
        return { key, budgeted, actual, variance, pct };
    });

    // Filter by search
    const filtered = search
        ? entries.filter(e => e.key.toLowerCase().includes(search))
        : entries;

    // Sort alphabetically
    filtered.sort((a, b) => a.key.localeCompare(b.key));

    // Update summary cards
    const totalItems = Object.keys(BUDGET).length;
    const totalBudget = entries.reduce((s, e) => s + e.budgeted, 0);
    const totalSpent = entries.reduce((s, e) => s + e.actual, 0);
    const totalVariance = totalBudget - totalSpent;

    const el = id => document.getElementById(id);
    if (el('totalBudgetItems')) el('totalBudgetItems').textContent = totalItems;
    if (el('totalBudgetAmount')) el('totalBudgetAmount').textContent = fmt(totalBudget);
    if (el('totalBudgetSpent')) {
        el('totalBudgetSpent').textContent = fmt(totalSpent);
        el('totalBudgetSpent').style.color = 'var(--red)';
    }
    if (el('totalBudgetVariance')) {
        el('totalBudgetVariance').textContent = (totalVariance < 0 ? '-' : '') + fmt(Math.abs(totalVariance));
        el('totalBudgetVariance').style.color = totalVariance >= 0 ? 'var(--green)' : 'var(--red)';
    }

    if (filtered.length === 0 && search) {
        listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>No budget lines match your search.</p></div>';
        return;
    }

    if (filtered.length === 0) {
        listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><p>No budget lines defined. Click "+ Add Line" to create one.</p></div>';
        return;
    }

    // Build table
    let html = '<table class="budget-table"><thead><tr>' +
        '<th>Category</th>' +
        '<th class="col-right">Budgeted</th>' +
        '<th class="col-right">Actual Spend</th>' +
        '<th class="col-right">Variance</th>' +
        '<th>Usage</th>' +
        '<th class="col-right">Actions</th>' +
        '</tr></thead><tbody>';

    // Data rows
    filtered.forEach(function(e) {
        var p = budgetPct(e.budgeted, e.actual);
        var varClass = e.variance < 0 ? 'negative' : 'positive';
        var safeKey = escapeHtml(e.key);
        html += '<tr>' +
            '<td><span class="budget-item-name">' + safeKey + '</span></td>' +
            '<td class="amount accent">' + fmt(e.budgeted) + '</td>' +
            '<td class="amount">' + (e.actual > 0 ? fmt(e.actual) : '<span class="muted">-</span>') + '</td>' +
            '<td class="amount ' + varClass + '">' + (e.variance < 0 ? '-' : '') + fmt(Math.abs(e.variance)) + '</td>' +
            '<td><div class="budget-usage-cell"><div class="mini-bar"><div class="mini-bar-fill ' + p.barClass + '" style="width:' + p.barWidth + '%"></div></div><span class="pct-label">' + p.label + '</span></div></td>' +
            '<td><div class="budget-item-actions">' +
                '<button class="btn btn-ghost btn-sm" onclick="openBudgetLineModal(\'' + safeKey.replace(/'/g, "\\'") + '\')">Edit</button>' +
                '<button class="btn btn-danger btn-sm" onclick="deleteBudgetLine(\'' + safeKey.replace(/'/g, "\\'") + '\')">Delete</button>' +
            '</div></td>' +
        '</tr>';
    });

    // Total row
    var tp = budgetPct(totalBudget, totalSpent);
    html += '<tr class="total-row">' +
        '<td><strong>TOTAL</strong></td>' +
        '<td class="amount accent">' + fmt(totalBudget) + '</td>' +
        '<td class="amount">' + fmt(totalSpent) + '</td>' +
        '<td class="amount ' + (totalVariance < 0 ? 'negative' : 'positive') + '">' + (totalVariance < 0 ? '-' : '') + fmt(Math.abs(totalVariance)) + '</td>' +
        '<td><div class="budget-usage-cell"><div class="mini-bar"><div class="mini-bar-fill ' + tp.barClass + '" style="width:' + tp.barWidth + '%"></div></div><span class="pct-label">' + tp.label + '</span></div></td>' +
        '<td></td>' +
    '</tr>';

    html += '</tbody></table>';
    listEl.innerHTML = html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================================
// EXPORT & STORAGE
// ============================================================
function exportCSV() {
    let csv = 'Date,Cheque#,Details,Category,Deposit,Payment\n';
    transactions.forEach(t => {
        csv += `"${t.date}","${t.cheque}","${t.details}","${t.category}",${t.deposit},${t.payment}\n`;
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const qm = getQuarterMeta(activeQ);
    a.download = 'CESTIS_CashBook_' + qm.shortLabel.replace(/[‚Äì]/g,'-') + '_' + getQuarterCalendarYear(activeFY, activeQ) + '.csv';
    a.click();
}

function saveToStorage() {
    const key = getCurrentQuarterKey();
    const data = { openingBalance: OPENING_BALANCE, transactions: transactions };
    try { localStorage.setItem(key, JSON.stringify(data)); } catch(e) {}
    // Also save active quarter preference
    try { localStorage.setItem('cestis_active_quarter', JSON.stringify({ fy: activeFY, q: activeQ })); } catch(e) {}
}

function loadFromStorage() {
    // Load active quarter preference
    try {
        const pref = localStorage.getItem('cestis_active_quarter');
        if (pref) {
            const p = JSON.parse(pref);
            activeFY = p.fy;
            activeQ = p.q;
        }
    } catch(e) {}

    loadQuarterData();
}

function loadQuarterData() {
    const key = getCurrentQuarterKey();
    try {
        const saved = localStorage.getItem(key);
        if (saved) {
            const data = JSON.parse(saved);
            OPENING_BALANCE = data.openingBalance || 0;
            transactions = data.transactions || [];
            // Recalculate nextId
            nextId = transactions.reduce((max, t) => Math.max(max, t.id + 1), 100);
        } else if (activeFY === '2025/2026' && activeQ === 3) {
            // Load default data for Q3 FY 2025/2026
            OPENING_BALANCE = 237948.69;
            transactions = JSON.parse(JSON.stringify(DEFAULT_TRANSACTIONS_Q3));
            nextId = 100;
            // Also migrate old localStorage data if it exists
            const oldData = localStorage.getItem('cesti_cashbook_data');
            if (oldData) {
                transactions = JSON.parse(oldData);
                nextId = transactions.reduce((max, t) => Math.max(max, t.id + 1), 100);
            }
        } else {
            // Empty quarter
            OPENING_BALANCE = 0;
            transactions = [];
            nextId = 100;
        }
    } catch(e) {
        OPENING_BALANCE = 0;
        transactions = [];
        nextId = 100;
    }
}

function saveQuarterAndSwitch(newFY, newQ) {
    // Save current quarter first
    saveToStorage();
    // Switch
    activeFY = newFY;
    activeQ = newQ;
    // Load new quarter
    loadQuarterData();
    loadDeletedBudgetKeys();
    loadBudgetOverrides();
    currentFilter = 'all';
    refreshAll();
    updateQuarterUI();
}

// ============================================================
// QUARTER NAVIGATION
// ============================================================
function updateQuarterUI() {
    // Update FY label
    document.getElementById('fyLabel').textContent = fyLabel(activeFY);
    // Update quarter tabs
    document.querySelectorAll('.quarter-tab').forEach((tab, i) => {
        tab.classList.toggle('active', i + 1 === activeQ);
    });
    // Update B/F input
    const bfInput = document.getElementById('quarterBF');
    if (bfInput) bfInput.value = OPENING_BALANCE.toFixed(2);
    // Update subvention fields
    populateSubventionFields();
    // Update month tabs
    renderMonthTabs();
}

function renderMonthTabs() {
    const container = document.getElementById('monthTabsContainer');
    if (!container) return;
    const qm = getQuarterMeta(activeQ);
    let html = '<div class="month-tab' + (currentFilter === 'all' ? ' active' : '') + '" onclick="filterMonth(\'all\', this)">All</div>';
    qm.months.forEach((m, i) => {
        html += '<div class="month-tab' + (currentFilter === m ? ' active' : '') + '" onclick="filterMonth(\'' + m + '\', this)">' + qm.monthNames[i] + '</div>';
    });
    container.innerHTML = html;
}

function switchQuarter(q) {
    if (q === activeQ) return;
    saveQuarterAndSwitch(activeFY, q);
}

function changeFY(dir) {
    const parts = activeFY.split('/');
    const y1 = parseInt(parts[0]) + dir;
    const y2 = y1 + 1;
    saveQuarterAndSwitch(y1 + '/' + y2, activeQ);
}

function changeQuarter(dir) {
    let newQ = activeQ + dir;
    let newFY = activeFY;
    if (newQ > 4) {
        newQ = 1;
        const y1 = parseInt(activeFY.split('/')[0]) + 1;
        newFY = y1 + '/' + (y1 + 1);
    } else if (newQ < 1) {
        newQ = 4;
        const y1 = parseInt(activeFY.split('/')[0]) - 1;
        newFY = y1 + '/' + (y1 + 1);
    }
    saveQuarterAndSwitch(newFY, newQ);
}

function updateQuarterBF() {
    const val = parseFloat(document.getElementById('quarterBF').value);
    if (isNaN(val)) return;
    OPENING_BALANCE = val;
    saveToStorage();
    refreshAll();
}

function carryForwardBalance() {
    // Calculate closing balance of previous quarter
    let prevQ = activeQ - 1;
    let prevFY = activeFY;
    if (prevQ < 1) {
        prevQ = 4;
        const y1 = parseInt(activeFY.split('/')[0]) - 1;
        prevFY = y1 + '/' + (y1 + 1);
    }
    const prevKey = getQuarterKey(prevFY, prevQ);
    try {
        const saved = localStorage.getItem(prevKey);
        if (saved) {
            const data = JSON.parse(saved);
            const prevOB = data.openingBalance || 0;
            const prevTxns = (data.transactions || []).filter(t => t.category !== 'Cancelled');
            const prevDeposits = prevTxns.reduce((s, t) => s + t.deposit, 0);
            const prevPayments = prevTxns.reduce((s, t) => s + t.payment, 0);
            const closingBal = prevOB + prevDeposits - prevPayments;
            OPENING_BALANCE = closingBal;
            document.getElementById('quarterBF').value = closingBal.toFixed(2);
            saveToStorage();
            refreshAll();
            alert('Balance B/F set to ' + fmt(closingBal) + ' (closing balance from ' + quarterPeriodLabel(prevFY, prevQ) + ')');
        } else {
            alert('No data found for the previous quarter (' + quarterPeriodLabel(prevFY, prevQ) + '). Please enter the Balance B/F manually or navigate to the previous quarter and enter transactions first.');
        }
    } catch(e) {
        alert('Could not load previous quarter data.');
    }
}

// ============================================================
// SUBVENTION MANAGEMENT
// ============================================================
function getSubventionTransaction() {
    return transactions.find(t => t.category === 'Subvention' && t.deposit > 0);
}

function updateSubvention() {
    const dateInput = document.getElementById('subventionDate');
    const amountInput = document.getElementById('subventionAmount');
    const date = dateInput.value;
    const amount = parseFloat(amountInput.value);

    // If both fields cleared, remove subvention transaction
    if (!date && (!amount || isNaN(amount) || amount <= 0)) {
        const existing = getSubventionTransaction();
        if (existing) {
            transactions = transactions.filter(t => t !== existing);
        }
        updateSubventionStatus(0);
        saveToStorage();
        refreshAll();
        return;
    }

    // Need at least amount > 0 to create/update
    if (isNaN(amount) || amount <= 0) {
        updateSubventionStatus(0);
        return;
    }

    const existing = getSubventionTransaction();
    if (existing) {
        // Update existing subvention transaction
        if (date) existing.date = date;
        existing.deposit = amount;
        existing.details = 'SUBVENTION';
    } else {
        // Create new subvention transaction
        const subDate = date || new Date().toISOString().slice(0, 10);
        transactions.push({
            id: nextId++,
            date: subDate,
            cheque: '',
            details: 'SUBVENTION',
            deposit: amount,
            payment: 0,
            category: 'Subvention'
        });
    }

    updateSubventionStatus(amount);
    saveToStorage();
    refreshAll();
}

function updateSubventionStatus(amount) {
    const el = document.getElementById('subventionStatus');
    if (!el) return;
    if (amount > 0) {
        el.textContent = '‚úì ' + fmt(amount);
        el.style.background = 'var(--green-bg)';
        el.style.color = 'var(--green)';
    } else {
        el.textContent = 'No subvention';
        el.style.background = 'var(--surface2)';
        el.style.color = 'var(--text3)';
    }
}

function populateSubventionFields() {
    const sub = getSubventionTransaction();
    const dateInput = document.getElementById('subventionDate');
    const amountInput = document.getElementById('subventionAmount');
    if (!dateInput || !amountInput) return;

    if (sub) {
        dateInput.value = sub.date || '';
        amountInput.value = sub.deposit > 0 ? sub.deposit.toFixed(2) : '';
        updateSubventionStatus(sub.deposit);
    } else {
        dateInput.value = '';
        amountInput.value = '';
        updateSubventionStatus(0);
    }
}

// ============================================================
// MONTHLY BANK RECONCILIATION
// ============================================================
let reconFY = '2025/2026';

function showPageDirect(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + page).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    // Highlight matching nav item if any
    document.querySelectorAll('.nav-item').forEach(n => {
        if (n.getAttribute('data-page') === page) n.classList.add('active');
    });
    if (page === 'monthly-recon') {
        reconFY = activeFY;
        renderMonthlyRecon();
    } else {
        refreshAll();
    }
}

function changeReconFY(dir) {
    const parts = reconFY.split('/');
    const y1 = parseInt(parts[0]) + dir;
    const y2 = y1 + 1;
    reconFY = y1 + '/' + y2;
    renderMonthlyRecon();
}

function getReconStorageKey(fy, q, monthKey) {
    return 'cestis_recon_bank_' + fy + '_Q' + q + '_' + monthKey;
}

function saveReconBankBalance(fy, q, monthKey, value) {
    try { localStorage.setItem(getReconStorageKey(fy, q, monthKey), value); } catch(e) {}
}

function loadReconBankBalance(fy, q, monthKey) {
    try { return localStorage.getItem(getReconStorageKey(fy, q, monthKey)) || ''; } catch(e) { return ''; }
}

function loadQuarterDataForRecon(fy, q) {
    const key = 'cestis_quarter_' + fy + '_Q' + q;
    try {
        const saved = localStorage.getItem(key);
        if (saved) {
            const data = JSON.parse(saved);
            return { openingBalance: data.openingBalance || 0, transactions: data.transactions || [] };
        } else if (fy === '2025/2026' && q === 3) {
            const oldData = localStorage.getItem('cesti_cashbook_data');
            if (oldData) {
                return { openingBalance: 237948.69, transactions: JSON.parse(oldData) };
            }
            return { openingBalance: 237948.69, transactions: JSON.parse(JSON.stringify(DEFAULT_TRANSACTIONS_Q3)) };
        }
    } catch(e) {}
    return { openingBalance: 0, transactions: [] };
}

function renderMonthlyRecon() {
    document.getElementById('reconFYLabel').textContent = fyLabel(reconFY);
    document.getElementById('reconFYSummaryLabel').textContent = reconFY;

    const quarterIcons = { 1: 'üìó', 2: 'üìò', 3: 'üìô', 4: 'üìï' };
    const quarterLabels = { 1: 'Quarter 1 ¬∑ April ‚Äì June', 2: 'Quarter 2 ¬∑ July ‚Äì September', 3: 'Quarter 3 ¬∑ October ‚Äì December', 4: 'Quarter 4 ¬∑ January ‚Äì March' };
    let cardsHtml = '';
    let fyTotalDeposits = 0, fyTotalPayments = 0, fyOpeningBalance = 0, fyClosingBalance = 0;
    let fyTotalBankCharges = 0, fyTotalUncleared = 0;
    let fyReconciled = 0, fyTotal = 0;

    [1, 2, 3, 4].forEach((q, qi) => {
        const qm = getQuarterMeta(q);
        const calYear = getQuarterCalendarYear(reconFY, q);
        const data = loadQuarterDataForRecon(reconFY, q);
        const activeTxns = data.transactions.filter(t => t.category !== 'Cancelled');
        let runningBalance = data.openingBalance;

        if (qi === 0) fyOpeningBalance = data.openingBalance;

        // Quarter section label
        cardsHtml += '<div class="recon-quarter-label">' + quarterIcons[q] + ' ' + quarterLabels[q] + ' <span class="badge">' + calYear + '</span></div>';

        qm.months.forEach((mKey, mi) => {
            const monthName = qm.monthNames[mi];
            const monthNum = qm.monthNums[mi];

            const monthTxns = activeTxns.filter(t => {
                if (!t.date) return false;
                return parseInt(t.date.split('-')[1]) === monthNum;
            });

            // Auto-calculate from transaction data
            const monthDeposits = monthTxns.reduce((sum, t) => sum + (t.deposit || 0), 0);
            const monthPayments = monthTxns.reduce((sum, t) => sum + (t.payment || 0), 0);
            const monthBankCharges = monthTxns.filter(t => t.category === 'Bank Charges').reduce((sum, t) => sum + (t.payment || 0), 0);
            const monthPaymentsExCharges = monthPayments - monthBankCharges;
            const monthCheques = monthTxns.filter(t => t.cheque && t.payment > 0);
            const chequeCount = monthCheques.length;
            const txnCount = monthTxns.length;

            const openBal = runningBalance;
            const closeBal = openBal + monthDeposits - monthPayments;
            runningBalance = closeBal;

            fyTotalDeposits += monthDeposits;
            fyTotalPayments += monthPayments;
            fyTotalBankCharges += monthBankCharges;

            const savedBank = loadReconBankBalance(reconFY, q, mKey);
            const bankVal = savedBank !== '' ? parseFloat(savedBank) : NaN;
            const diff = !isNaN(bankVal) ? bankVal - closeBal : NaN;
            const diffDisplay = !isNaN(diff) ? ((diff >= 0 ? '' : '-') + fmt(Math.abs(diff))) : '‚Äî';
            const diffColor = !isNaN(diff) ? (Math.abs(diff) < 1 ? 'var(--green)' : 'var(--red)') : 'var(--text3)';

            // Pre-calculate uncleared cheques total for status determination
            const preUnclearedList = loadUnclearedCheques(reconFY, q, mKey);
            let preUnclearedTotal = 0;
            monthCheques.forEach(function(chq) {
                if (preUnclearedList.indexOf(chq.id) >= 0) preUnclearedTotal += chq.payment;
            });
            fyTotalUncleared += preUnclearedTotal;
            const preAdjustedDiff = !isNaN(bankVal) ? (bankVal - preUnclearedTotal) - closeBal : NaN;

            // Status based on adjusted difference (bank balance minus uncleared cheques vs cashbook)
            let statusClass, statusText;
            if (isNaN(bankVal) || savedBank === '') {
                statusClass = 'pending'; statusText = 'Pending';
            } else if (Math.abs(preAdjustedDiff) < 1) {
                statusClass = 'matched'; statusText = 'Reconciled';
                fyReconciled++;
            } else {
                statusClass = 'unmatched'; statusText = 'Unmatched';
            }
            fyTotal++;

            cardsHtml += '<div class="recon-month-card ' + statusClass + '">' +
                '<div class="recon-month-header">' +
                    '<h3>üìÖ ' + monthName + ' ' + calYear + '</h3>' +
                    '<span class="recon-status ' + statusClass + '">' + statusText + '</span>' +
                '</div>' +
                '<div class="recon-month-body">' +
                    '<div class="recon-month-stats">' +
                        '<div class="recon-month-stat"><div class="stat-label">Opening Balance</div><div class="stat-value" style="color:var(--accent2);">' + fmt(openBal) + '</div></div>' +
                        '<div class="recon-month-stat"><div class="stat-label">Deposits</div><div class="stat-value" style="color:var(--green);">' + fmt(monthDeposits) + '</div></div>' +
                        '<div class="recon-month-stat"><div class="stat-label">Closing Balance</div><div class="stat-value">' + fmt(closeBal) + '</div></div>' +
                        '<div class="recon-month-stat"><div class="stat-label">Transactions</div><div class="stat-value" style="color:var(--text2);">' + txnCount + '</div></div>' +
                    '</div>' +
                    '<div class="recon-month-details">' +
                        '<div class="recon-detail-row">' +
                            '<span class="detail-label">Payments (' + chequeCount + ' cheques)</span>' +
                            '<span class="detail-value" style="color:var(--red);">- ' + fmt(monthPaymentsExCharges) + '</span>' +
                        '</div>' +
                        '<div class="recon-detail-row">' +
                            '<span class="detail-label">Bank Charges</span>' +
                            '<span class="detail-value" style="color:var(--amber);">- ' + fmt(monthBankCharges) + '</span>' +
                        '</div>' +
                        '<div class="recon-detail-row subtotal">' +
                            '<span class="detail-label">Total Deductions</span>' +
                            '<span class="detail-value" style="color:var(--red);">- ' + fmt(monthPayments) + '</span>' +
                        '</div>' +
                    '</div>';

            // Cheque register toggle with uncleared checkboxes
            // (reuses preUnclearedList from status calculation above)
            var unclearedCheques = [];

            if (chequeCount > 0) {
                var chequesId = 'recon-cheques-' + q + '-' + mKey;
                cardsHtml += '<button class="recon-cheques-toggle" onclick="toggleReconCheques(\'' + chequesId + '\')">' +
                    '‚ñ∏ View ' + chequeCount + ' cheque(s) issued ‚Äî tick uncleared cheques</button>' +
                    '<div class="recon-cheques-list" id="' + chequesId + '">' +
                        '<table><thead><tr><th style="width:30px">Uncleared</th><th>Chq #</th><th>Payee</th><th style="text-align:right">Amount</th></tr></thead><tbody>';
                monthCheques.forEach(function(chq) {
                    var isUncleared = preUnclearedList.indexOf(chq.id) >= 0;
                    if (isUncleared) unclearedCheques.push(chq);
                    cardsHtml += '<tr class="' + (isUncleared ? 'cheque-uncleared' : '') + '">' +
                        '<td style="text-align:center"><input type="checkbox" ' + (isUncleared ? 'checked' : '') +
                            ' onchange="toggleUnclearedCheque(\'' + reconFY + '\',' + q + ',\'' + mKey + '\',' + chq.id + ')" title="Mark as not yet cleared at bank"></td>' +
                        '<td class="cheque-num">' + chq.cheque + '</td>' +
                        '<td>' + chq.details + '</td>' +
                        '<td class="amount negative">' + fmt(chq.payment) + '</td></tr>';
                });
                cardsHtml += '</tbody></table></div>';
            }

            // Adjusted bank balance = bank statement - uncleared cheques
            var adjustedBankBal = !isNaN(bankVal) ? bankVal - preUnclearedTotal : NaN;
            var adjustedDiff = !isNaN(adjustedBankBal) ? adjustedBankBal - closeBal : NaN;
            var adjustedDiffDisplay = !isNaN(adjustedDiff) ? ((adjustedDiff >= 0 ? '' : '-') + fmt(Math.abs(adjustedDiff))) : '‚Äî';
            var adjustedDiffColor = !isNaN(adjustedDiff) ? (Math.abs(adjustedDiff) < 1 ? 'var(--green)' : 'var(--red)') : 'var(--text3)';

            cardsHtml +=
                    '<div class="recon-month-bank">' +
                        '<label>Bank Statement Balance:</label>' +
                        '<input type="number" step="0.01" value="' + (savedBank !== '' ? savedBank : '') + '" ' +
                            'onchange="onReconBankInput(\'' + reconFY + '\',' + q + ',\'' + mKey + '\',this.value)" ' +
                            'placeholder="Enter bank balance">' +
                        '<span class="recon-diff" style="color:' + diffColor + ';">Raw Diff: ' + diffDisplay + '</span>' +
                    '</div>';

            // Bank Reconciliation Statement section
            if (!isNaN(bankVal)) {
                cardsHtml += '<div class="recon-statement">' +
                    '<div class="recon-statement-title">üìã Bank Reconciliation Statement</div>' +
                    '<div class="recon-statement-line">' +
                        '<span class="rs-label">Balance per Bank Statement</span>' +
                        '<span class="rs-value">' + fmt(bankVal) + '</span>' +
                    '</div>';

                if (unclearedCheques.length > 0) {
                    cardsHtml += '<div class="recon-statement-line">' +
                        '<span class="rs-label">Less: Cheques Issued &amp; Not Yet Cleared (' + unclearedCheques.length + ')</span>' +
                        '<span class="rs-value" style="color:var(--amber);">- ' + fmt(preUnclearedTotal) + '</span>' +
                    '</div>';
                    unclearedCheques.forEach(function(uc) {
                        cardsHtml += '<div class="recon-statement-line rs-indent">' +
                            '<span class="rs-label">Chq #' + uc.cheque + ' ‚Äî ' + uc.details + '</span>' +
                            '<span class="rs-value">' + fmt(uc.payment) + '</span>' +
                        '</div>';
                    });
                } else {
                    cardsHtml += '<div class="recon-statement-line">' +
                        '<span class="rs-label">Less: Cheques Issued &amp; Not Yet Cleared</span>' +
                        '<span class="rs-value" style="color:var(--text3);">$0.00</span>' +
                    '</div>';
                }

                cardsHtml += '<div class="recon-statement-line rs-subtotal">' +
                        '<span class="rs-label">Adjusted Bank Balance</span>' +
                        '<span class="rs-value" style="color:var(--accent2);">' + fmt(adjustedBankBal) + '</span>' +
                    '</div>' +
                    '<div class="recon-statement-line">' +
                        '<span class="rs-label">Balance per Cash Book</span>' +
                        '<span class="rs-value">' + fmt(closeBal) + '</span>' +
                    '</div>' +
                    '<div class="recon-statement-line rs-total">' +
                        '<span class="rs-label">Difference</span>' +
                        '<span class="rs-value" style="color:' + adjustedDiffColor + ';">' + adjustedDiffDisplay + '</span>' +
                    '</div>' +
                '</div>';
            }

            cardsHtml +=
                '</div>' +
            '</div>';
        });

        fyClosingBalance = runningBalance;
    });

    document.getElementById('reconMonthCards').innerHTML = cardsHtml;

    // Fiscal year summary with bank charges and uncleared cheques
    const summaryHtml =
        '<div class="recon-summary-item"><div class="label">Opening Balance</div><div class="value" style="color:var(--accent2);">' + fmt(fyOpeningBalance) + '</div></div>' +
        '<div class="recon-summary-item"><div class="label">Total Deposits</div><div class="value" style="color:var(--green);">' + fmt(fyTotalDeposits) + '</div></div>' +
        '<div class="recon-summary-item"><div class="label">Total Payments</div><div class="value" style="color:var(--red);">' + fmt(fyTotalPayments) + '</div></div>' +
        '<div class="recon-summary-item"><div class="label">Total Bank Charges</div><div class="value" style="color:var(--amber);">' + fmt(fyTotalBankCharges) + '</div></div>' +
        '<div class="recon-summary-item"><div class="label">Uncleared Cheques</div><div class="value" style="color:var(--amber);">' + fmt(fyTotalUncleared) + '</div></div>' +
        '<div class="recon-summary-item"><div class="label">Closing Balance</div><div class="value" style="color:var(--accent2);">' + fmt(fyClosingBalance) + '</div></div>' +
        '<div class="recon-summary-item"><div class="label">Months Reconciled</div><div class="value" style="color:' + (fyReconciled === fyTotal ? 'var(--green)' : 'var(--amber)') + ';">' + fyReconciled + ' / ' + fyTotal + '</div></div>';

    document.getElementById('reconFYSummary').innerHTML = summaryHtml;
}

function toggleReconCheques(id) {
    var el = document.getElementById(id);
    if (!el) return;
    el.classList.toggle('open');
    var btn = el.previousElementSibling;
    if (btn) btn.textContent = el.classList.contains('open') ? btn.textContent.replace('‚ñ∏', '‚ñæ') : btn.textContent.replace('‚ñæ', '‚ñ∏');
}

function onReconBankInput(fy, q, monthKey, value) {
    saveReconBankBalance(fy, q, monthKey, value);
    renderMonthlyRecon();
}

// Uncleared cheques storage
function getUnclearedKey(fy, q, monthKey) {
    return 'cestis_recon_uncleared_' + fy + '_Q' + q + '_' + monthKey;
}

function saveUnclearedCheques(fy, q, monthKey, chequeIds) {
    try { localStorage.setItem(getUnclearedKey(fy, q, monthKey), JSON.stringify(chequeIds)); } catch(e) {}
}

function loadUnclearedCheques(fy, q, monthKey) {
    try {
        const saved = localStorage.getItem(getUnclearedKey(fy, q, monthKey));
        return saved ? JSON.parse(saved) : [];
    } catch(e) { return []; }
}

function toggleUnclearedCheque(fy, q, monthKey, chequeId) {
    const list = loadUnclearedCheques(fy, q, monthKey);
    const idx = list.indexOf(chequeId);
    if (idx >= 0) list.splice(idx, 1);
    else list.push(chequeId);
    saveUnclearedCheques(fy, q, monthKey, list);
    renderMonthlyRecon();
}

// ============================================================
// AUTHENTICATION
// ============================================================
const AUTH_CREDENTIALS = {
    username: 'cestisadmin',
    password: 'cestisadmin123$'
};
const AUTH_SESSION_KEY = 'cestis_auth_session';

function isAuthenticated() {
    try {
        const session = JSON.parse(localStorage.getItem(AUTH_SESSION_KEY));
        if (!session || !session.loggedIn) return false;
        // Session expires after 8 hours
        if (Date.now() - session.timestamp > 8 * 60 * 60 * 1000) {
            localStorage.removeItem(AUTH_SESSION_KEY);
            return false;
        }
        return true;
    } catch(e) { return false; }
}

/* ============================================================
   CLAUDE CODE CRAB ‚Äî eyes follow cursor, flees when close
   ============================================================ */
(function initCrab() {
    var crab = document.getElementById('crabWrapper');
    if (!crab) return;
    var overlay = document.getElementById('loginOverlay');
    var card = crab.parentElement.querySelector('.login-card');

    var pupilL = document.getElementById('pupilL');
    var pupilR = document.getElementById('pupilR');
    var shineL = document.getElementById('shineL');
    var shineR = document.getElementById('shineR');

    // Resting pupil centers
    var PL = { cx:26, cy:24 }, PR = { cx:40, cy:24 };
    var SL = { cx:24.5, cy:22 }, SR = { cx:38.5, cy:22 };
    var maxPupilShift = 2.5; // px inside eye socket

    var fleeRadius = 120;
    var fleeSpeed  = 180;
    var restTimeout = null;
    var isFleeing = false;

    /* ---- position helpers ---- */
    // Crab starts CSS-positioned (bottom:100%, margin-bottom:-26px on .login-card parent)
    // When fleeing we switch to absolute top/left on the overlay
    function resetToRest() {
        crab.style.position = '';
        crab.style.left = '';
        crab.style.top = '';
        crab.style.bottom = '';
        crab.style.transform = '';
    }

    function setCrabAbsolute(x, y) {
        // Position relative to the overlay
        crab.style.position = 'fixed';
        crab.style.bottom = 'auto';
        crab.style.left = x + 'px';
        crab.style.top  = y + 'px';
        crab.style.transform = 'translate(-50%, -50%)';
    }

    function getCrabCenter() {
        var r = crab.getBoundingClientRect();
        return { x: r.left + r.width / 2, y: r.top + r.height / 2 };
    }

    /* ---- eye tracking ---- */
    function trackEyes(clientX, clientY) {
        if (isFleeing) return;
        var cc = getCrabCenter();
        var dx = clientX - cc.x;
        var dy = clientY - cc.y;
        var dist = Math.sqrt(dx * dx + dy * dy) || 1;
        var ratio = Math.min(1, 60 / dist); // stronger when closer
        var shiftX = (dx / dist) * maxPupilShift * ratio;
        var shiftY = (dy / dist) * maxPupilShift * ratio;

        pupilL.setAttribute('cx', PL.cx + shiftX);
        pupilL.setAttribute('cy', PL.cy + shiftY);
        pupilR.setAttribute('cx', PR.cx + shiftX);
        pupilR.setAttribute('cy', PR.cy + shiftY);
        shineL.setAttribute('cx', SL.cx + shiftX * 0.6);
        shineL.setAttribute('cy', SL.cy + shiftY * 0.6);
        shineR.setAttribute('cx', SR.cx + shiftX * 0.6);
        shineR.setAttribute('cy', SR.cy + shiftY * 0.6);
    }

    function resetEyes() {
        pupilL.setAttribute('cx', PL.cx);
        pupilL.setAttribute('cy', PL.cy);
        pupilR.setAttribute('cx', PR.cx);
        pupilR.setAttribute('cy', PR.cy);
        shineL.setAttribute('cx', SL.cx);
        shineL.setAttribute('cy', SL.cy);
        shineR.setAttribute('cx', SR.cx);
        shineR.setAttribute('cy', SR.cy);
    }

    /* ---- flee logic ---- */
    function onMove(e) {
        trackEyes(e.clientX, e.clientY);

        var cc = getCrabCenter();
        var dx = cc.x - e.clientX;
        var dy = cc.y - e.clientY;
        var dist = Math.sqrt(dx * dx + dy * dy);

        if (dist < fleeRadius && dist > 0) {
            isFleeing = true;
            crab.classList.add('fleeing');
            crab.classList.remove('resting');

            var angle = Math.atan2(dy, dx);
            var nx = cc.x + Math.cos(angle) * fleeSpeed;
            var ny = cc.y + Math.sin(angle) * fleeSpeed;

            // Clamp inside viewport
            var pad = 50;
            nx = Math.max(pad, Math.min(window.innerWidth - pad, nx));
            ny = Math.max(pad, Math.min(window.innerHeight - pad, ny));

            // Flip to face away from cursor
            if (e.clientX < cc.x) {
                crab.classList.add('flipped');
            } else {
                crab.classList.remove('flipped');
            }

            setCrabAbsolute(nx, ny);

            // Return home after 1.2s
            clearTimeout(restTimeout);
            restTimeout = setTimeout(function() {
                isFleeing = false;
                crab.classList.remove('fleeing');
                crab.classList.add('resting');
                crab.classList.remove('flipped');
                // Animate back: briefly keep fixed at rest position then reset
                var cardR = card.getBoundingClientRect();
                var homeX = cardR.left + cardR.width / 2;
                var homeY = cardR.top - 26; // half-in above card
                crab.style.transition = 'left .6s ease, top .6s ease';
                crab.style.left = homeX + 'px';
                crab.style.top  = homeY + 'px';
                setTimeout(function() {
                    crab.style.transition = '';
                    resetToRest();
                    resetEyes();
                }, 650);
            }, 1200);
        }
    }

    overlay.addEventListener('mousemove', onMove);
})();

function handleLogin(e) {
    e.preventDefault();
    const btn = document.getElementById('loginBtn');
    const errorEl = document.getElementById('loginError');
    const errorMsg = document.getElementById('loginErrorMsg');
    const user = document.getElementById('loginUser').value.trim();
    const pass = document.getElementById('loginPass').value;

    // Hide previous error
    errorEl.classList.remove('visible');

    // Validate
    if (!user || !pass) {
        errorMsg.textContent = 'Please enter both username and password';
        errorEl.classList.add('visible');
        return;
    }

    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Signing in...';

    // Simulate brief network delay for realistic feel
    setTimeout(function() {
        if (user === AUTH_CREDENTIALS.username && pass === AUTH_CREDENTIALS.password) {
            // Success - store session
            localStorage.setItem(AUTH_SESSION_KEY, JSON.stringify({
                loggedIn: true,
                user: user,
                timestamp: Date.now()
            }));
            showApp();
        } else {
            // Failure
            errorMsg.textContent = 'Invalid username or password';
            errorEl.classList.add('visible');
            btn.disabled = false;
            btn.innerHTML = 'Sign In';
            document.getElementById('loginPass').value = '';
            document.getElementById('loginPass').focus();
        }
    }, 600);
}

function handleLogout() {
    localStorage.removeItem(AUTH_SESSION_KEY);
    // Reset form
    document.getElementById('loginUser').value = '';
    document.getElementById('loginPass').value = '';
    document.getElementById('loginError').classList.remove('visible');
    document.getElementById('loginBtn').disabled = false;
    document.getElementById('loginBtn').innerHTML = 'Sign In';
    // Show login, hide app
    document.getElementById('loginOverlay').classList.remove('hidden');
    document.getElementById('appContainer').classList.add('app-hidden');
}

function showApp() {
    document.getElementById('loginOverlay').classList.add('hidden');
    document.getElementById('appContainer').classList.remove('app-hidden');
    // Initialize app data if not already loaded
    loadFromStorage();
    loadDeletedBudgetKeys();
    loadBudgetOverrides();
    refreshAll();
    updateQuarterUI();
    // Initialize cloud sync UI
    initCurrentUser();
    updateCloudUI();
}

function togglePasswordVisibility() {
    const input = document.getElementById('loginPass');
    const btn = input.parentElement.querySelector('.toggle-password');
    if (input.type === 'password') {
        input.type = 'text';
        btn.innerHTML = '&#x1f648;';
    } else {
        input.type = 'password';
        btn.innerHTML = '&#x1f441;';
    }
}

// ============================================
// (Legacy smart merge removed ‚Äî replaced by mergeFromCloud)
// ============================================



// ==================== END CLOUD SYNC ====================

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
    // Always require login on page load/refresh
    localStorage.removeItem(AUTH_SESSION_KEY);

    // Check for Google OAuth callback token in URL hash (redirect flow fallback)
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = hashParams.get('access_token');
    if (accessToken) {
        googleAccessToken = accessToken;
        isCloudConnected = true;
        history.replaceState(null, '', window.location.pathname + window.location.search);

        // Save token with 1 hour expiry
        const expiry = new Date();
        expiry.setHours(expiry.getHours() + 1);
        localStorage.setItem('cestisGoogleAccessToken', accessToken);
        localStorage.setItem('cestisGoogleTokenExpiry', expiry.toISOString());

        findExistingBackupFile();
    }

    // Initialize cloud sync (checks for saved token)
    initializeCloudSync();

    // Initialize Google Identity Services after a brief delay
    setTimeout(() => { initGoogleAuth(); }, 500);

    // Login overlay is visible and app is hidden by default;
    // user must always sign in after a page refresh
});
</script>

</body>
</html>
